#!/usr/bin/env bash

set -euo pipefail

# Base URL for the local RouteCodex router (override with RCC_BASE_URL if needed)
BASE_URL="${RCC_BASE_URL:-http://127.0.0.1:5520}"

export ANTHROPIC_BASE_URL="${BASE_URL}"
export ANTHROPIC_API_BASE="${BASE_URL}"
export ANTHROPIC_API_URL="${BASE_URL}"

declare -a args=("$@")

supports_codex=false
if claude --help 2>/dev/null | grep -q -- '--codex'; then
  supports_codex=true
fi

if [[ "${supports_codex}" == "false" ]]; then
  declare -a filtered=()
  if [[ ${#args[@]} -gt 0 ]]; then
    for arg in "${args[@]}"; do
      if [[ "${arg}" == "--codex" ]]; then
        continue
      fi
      filtered+=("${arg}")
    done
    if [[ ${#filtered[@]} -gt 0 ]]; then
      args=("${filtered[@]}")
    else
      args=()
    fi
  else
    args=()
  fi
fi

has_codex=false
if [[ ${#args[@]} -gt 0 ]]; then
  for arg in "${args[@]}"; do
    if [[ "${arg}" == "--codex" ]]; then
      has_codex=true
      break
    fi
  done
fi

if [[ "${supports_codex}" == "true" ]]; then
  if [[ "${has_codex}" == "false" ]]; then
    if [[ ${#args[@]} -gt 0 ]]; then
    if [[ ${#args[@]} -gt 0 ]]; then
      args=("--codex" "${args[@]}")
    else
      args=("--codex")
    fi
    else
      args=("--codex")
    fi
  fi
else
  codex_prompt_path="${RCC_CODEX_PROMPT_PATH:-$HOME/.routecodex/codex-system-prompt.txt}"
  if [[ -f "${codex_prompt_path}" ]]; then
    codex_prompt=$(cat "${codex_prompt_path}")
    if [[ ${#args[@]} -gt 0 ]]; then
      args=("--append-system-prompt" "${codex_prompt}" "${args[@]}")
    else
      args=("--append-system-prompt" "${codex_prompt}")
    fi
  else
    printf 'Warning: codex system prompt not found at %s\n' "${codex_prompt_path}" 1>&2
  fi
fi

exec claude "${args[@]}"
