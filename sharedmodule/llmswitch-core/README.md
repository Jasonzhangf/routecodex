# @routecodex/llmswitch-core

RouteCodex LLMSwitch æ ¸å¿ƒæ¨¡å—ï¼Œæä¾› AI æœåŠ¡æä¾›å•†ä¹‹é—´çš„åè®®è½¬æ¢å’Œæ ‡å‡†åŒ–åŠŸèƒ½ã€‚

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

æœ¬æ¨¡å—é‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Conversion Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Codecs    â”‚   Streaming  â”‚      Responses          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚OpenAI   â”‚â”‚ â”‚SSE        â”‚â”‚ â”‚OpenAIâ†”Chat Bridge   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚Anthropicâ”‚â”‚ â”‚Coalescing â”‚â”‚ â”‚Tool Call Conversion â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Switch Orchestrator                     â”‚
â”‚                    ç»Ÿä¸€è½¬æ¢è°ƒåº¦ä¸­å¿ƒ                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Provider Adapters                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   OpenAI    â”‚  Anthropic   â”‚      Responses          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚Normalizer â”‚â”‚ â”‚Converter  â”‚â”‚ â”‚Passthrough Handlerâ”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ æ ¸å¿ƒåŠŸèƒ½

### 1. åè®®è½¬æ¢ç¼–è§£ç å™¨ (Codecs)
- **OpenAIâ†”OpenAI**: OpenAI Chat è§„èŒƒåŒ–
- **Anthropicâ†”OpenAI**: Anthropic Messages ä¸ OpenAI Chat åŒå‘è½¬æ¢
- **Responsesâ†”OpenAI**: OpenAI Responses API ä¸ Chat API è½¬æ¢

### 2. æµå¼å¤„ç†
- **SSE äº‹ä»¶èšåˆ**: æ™ºèƒ½åˆå¹¶æµå¼å“åº”äº‹ä»¶
- **æ¶ˆæ¯ç¼“å†²**: ä¼˜åŒ–æµå¼ä¼ è¾“æ€§èƒ½

### 3. å·¥å…·è°ƒç”¨æ ‡å‡†åŒ–
- **ç»Ÿä¸€å·¥å…·æ ¼å¼**: æ ‡å‡†åŒ–ä¸åŒæä¾›å•†çš„å·¥å…·è°ƒç”¨æ ¼å¼
- **å‚æ•°éªŒè¯**: JSON Schema éªŒè¯å’Œä¿®å¤
- **MCP é›†æˆ**: Model Context Protocol æ”¯æŒ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºç¡€å¯¼å…¥

```typescript
// è½¬æ¢æ ¸å¿ƒåŠŸèƒ½
import { normalizeChatRequest, normalizeChatResponse } from 'rcc-llmswitch-core/conversion';

// ç‰¹å®šç¼–è§£ç å™¨
import { OpenAIOpenAIConversionCodec } from 'rcc-llmswitch-core/conversion/codecs/openai-openai-codec';
import { AnthropicOpenAIConversionCodec } from 'rcc-llmswitch-core/conversion/codecs/anthropic-openai-codec';

// è·¯ç”±å’Œåè°ƒå™¨
import { SwitchOrchestrator } from 'rcc-llmswitch-core/conversion/switch-orchestrator';
```

### ä½¿ç”¨ç¤ºä¾‹

```typescript
// OpenAI è§„èŒƒåŒ–
const normalizedRequest = normalizeChatRequest(openaiRequest);
const normalizedResponse = normalizeChatResponse(openaiResponse);

// Anthropicâ†”OpenAI è½¬æ¢
const converter = new AnthropicOpenAIConversionCodec();
const openaiFormat = converter.encode(anthropicMessage);
const anthropicFormat = converter.decode(openaiChat);
```

## ğŸ“‹ æ¨¡å—å¯¼å‡º

| å¯¼å‡ºè·¯å¾„ | åŠŸèƒ½æè¿° |
|---------|---------|
| `rcc-llmswitch-core` | ä¸»æ¨¡å—å…¥å£ |
| `rcc-llmswitch-core/conversion` | è½¬æ¢æ ¸å¿ƒåŠŸèƒ½ |
| `rcc-llmswitch-core/conversion/switch-orchestrator` | è½¬æ¢åè°ƒå™¨ |
| `rcc-llmswitch-core/llmswitch/llmswitch-conversion-router` | è½¬æ¢è·¯ç”±å™¨ |
| `rcc-llmswitch-core/llmswitch/openai-normalizer` | OpenAI è§„èŒƒåŒ–å™¨ |
| `rcc-llmswitch-core/llmswitch/anthropic-openai-converter` | Anthropicâ†”OpenAI è½¬æ¢å™¨ |
| `rcc-llmswitch-core/guidance` | å·¥å…·æŒ‡å¯¼åŠŸèƒ½ |

## ğŸ”§ æŠ€æœ¯è§„èŒƒ

### æ•°æ®æ ¼å¼çº¦å®š

1. **å·¥å…·è°ƒç”¨æ ¼å¼**
   ```typescript
   assistant.tool_calls[].function.arguments // å¿…é¡»ä¸º JSON å­—ç¬¦ä¸²
   ```
   - å¯¹è±¡ä¼šè¢«è‡ªåŠ¨ JSON.stringify
   - å·¥å…·å®šä¹‰é‡‡ç”¨ OpenAI function å½¢çŠ¶

2. **å·¥å…·å®šä¹‰ç»“æ„**
   ```typescript
   {
     type: 'function',
     function: {
       name: string,
       description?: string,
       parameters: JSONSchema
     }
   }
   ```

3. **åç§°è§„èŒƒåŒ–**
   - ä»…å…è®¸å­—ç¬¦ï¼š`[a-zA-Z0-9_-]`
   - æœ€å¤§é•¿åº¦ï¼š64 å­—ç¬¦

### ç¯å¢ƒå˜é‡é…ç½®

| å˜é‡å | æè¿° | é»˜è®¤å€¼ |
|-------|------|--------|
| `RCC_ALLOWED_TOOLS` | é¢å¤–å…è®¸çš„å‡½æ•°å·¥å…·ï¼ˆé€—å·åˆ†éš”ï¼‰ | - |
| `RCC_TOOL_LIMIT` | å·¥å…·æœ€å¤§ä¿ç•™æ•°é‡ | `32` |
| `ROUTECODEX_MCP_ENABLE` | å¯ç”¨ MCP é›†æˆ | `'1'` |
| `RCC_SYSTEM_TOOL_GUIDANCE` | å¯ç”¨ç³»ç»Ÿå·¥å…·æŒ‡å¯¼ | `'1'` |
| `ROUTECODEX_TOOL_OUTPUT_LIMIT` | å·¥å…·è¾“å‡ºé•¿åº¦é™åˆ¶ | `1000` |
| `RCC_O2A_COALESCE_MS` | OpenAIâ†’Anthropic èšåˆçª—å£ | `1000ms` |
| `RCC_R2C_COALESCE_MS` | Responsesâ†’Chat èšåˆçª—å£ | `1000ms` |

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ conversion/           # è½¬æ¢æ ¸å¿ƒ
â”‚   â”œâ”€â”€ codecs/          # åè®®ç¼–è§£ç å™¨
â”‚   â”œâ”€â”€ responses/       # Responses API å¤„ç†
â”‚   â”œâ”€â”€ shared/          # å…±äº«å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ streaming/       # æµå¼å¤„ç†
â”‚   â”œâ”€â”€ codec-registry.ts    # ç¼–è§£ç å™¨æ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ switch-orchestrator.ts # è½¬æ¢åè°ƒå™¨
â”‚   â””â”€â”€ types.ts         # ç±»å‹å®šä¹‰
â”œâ”€â”€ llmswitch/           # LLMSwitch å®ç°
â”‚   â”œâ”€â”€ anthropic-openai-converter.ts
â”‚   â”œâ”€â”€ llmswitch-conversion-router.ts
â”‚   â”œâ”€â”€ llmswitch-response-chat.ts
â”‚   â”œâ”€â”€ llmswitch-responses-passthrough.ts
â”‚   â””â”€â”€ openai-normalizer.ts
â”œâ”€â”€ types/               # TypeScript ç±»å‹å®šä¹‰
â””â”€â”€ guidance/            # å·¥å…·æŒ‡å¯¼åŠŸèƒ½
```

## âš ï¸ å·²çŸ¥é—®é¢˜

### ä»£ç é‡å¤
- `splitCommandString()` å‡½æ•°åœ¨å¤šä¸ªæ–‡ä»¶ä¸­é‡å¤å®ç°
- `normalizeTools()` å‡½æ•°é‡å¤å®ç°
- å·¥å…·è¾“å‡ºæ¸…ç†é€»è¾‘åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶

### ç¡¬ç¼–ç é—®é¢˜
- ç¯å¢ƒå˜é‡é»˜è®¤å€¼åˆ†æ•£åœ¨å„æ–‡ä»¶
- æ–‡ä»¶è·¯å¾„å’Œé­”æ³•æ•°å­—ç¼ºä¹ç»Ÿä¸€ç®¡ç†
- MCP å·¥å…·åˆ—è¡¨ç¡¬ç¼–ç åœ¨å¤šå¤„

### æ¶æ„æ”¹è¿›è®¡åˆ’
1. **å·¥å…·æ ‡å‡†åŒ–æ ¸å¿ƒ**: åˆ›å»ºç»Ÿä¸€çš„ `ToolNormalizer` ç±»
2. **é…ç½®ç®¡ç†ä¸­å¿ƒ**: é›†ä¸­ç®¡ç†ç¯å¢ƒå˜é‡å’Œå¸¸é‡
3. **MCP ç®¡ç†å™¨**: ç»Ÿä¸€ MCP æœåŠ¡å™¨å‘ç°å’Œå·¥å…·æ³¨å…¥
4. **è¾“å‡ºæ¸…ç†å™¨**: ç»Ÿä¸€å·¥å…·è¾“å‡ºå¤„ç†å’Œæˆªæ–­é€»è¾‘

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [æ¶æ„è®¾è®¡æ–‡æ¡£](../../docs/ARCHITECTURE.md)
- [æµæ°´çº¿æ¶æ„](../../docs/pipeline/ARCHITECTURE.md)
- [LM Studio é›†æˆæŒ‡å—](../../docs/lmstudio-tool-calling.md)

## ğŸ“„ è®¸å¯è¯

MIT License - è¯¦è§é¡¹ç›®æ ¹ç›®å½• LICENSE æ–‡ä»¶
