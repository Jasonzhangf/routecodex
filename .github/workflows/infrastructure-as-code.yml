name: Infrastructure as Code Security

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'terraform/**'
      - 'k8s/**'
      - 'docker-compose.yml'
      - '.github/workflows/infrastructure-as-code.yml'
      - 'helm/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'terraform/**'
      - 'k8s/**'
      - 'docker-compose.yml'
      - 'helm/**'

env:
  TERRAFORM_VERSION: '1.7.0'
  HELM_VERSION: '3.13.0'

jobs:
  # Terraform ÂÆâÂÖ®Ê£ÄÊü•
  terraform-security:
    runs-on: ubuntu-latest
    if: hashFiles('terraform/**/*.tf') != ''
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}

    - name: Terraform Format Check
      run: |
        cd terraform
        terraform fmt -check -recursive
        if [ $? -ne 0 ]; then
          echo "‚ùå Terraform files are not properly formatted"
          echo "Run 'terraform fmt -recursive' to fix formatting issues"
          exit 1
        fi

    - name: Terraform Init
      run: |
        cd terraform
        terraform init -backend=false

    - name: Terraform Validate
      run: |
        cd terraform
        terraform validate

    - name: Run Checkov Security Scan
      uses: bridgecrewio/checkov-action@v12
      with:
        directory: terraform/
        framework: terraform
        output_format: sarif
        output_file_path: checkov-results.sarif
        download_external_modules: true
        compact: true
        quiet: false
        soft_fail: false
        severity: medium

    - name: Upload Checkov scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: checkov-results.sarif

    - name: Run tfsec Security Scan
      uses: aquasecurity/tfsec-action@v1.0.3
      with:
        working_directory: terraform/
        format: sarif
        out: tfsec-results.sarif
        soft_fail: false
        severity: medium

    - name: Upload tfsec scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: tfsec-results.sarif

    - name: Terraform Cost Estimation
      uses: terraform-linters/tflint@v1
      with:
        tflint_version: v0.50.0
        working_directory: terraform/

    - name: Check for hardcoded secrets in Terraform
      run: |
        # Ê£ÄÊü•TerraformÊñá‰ª∂‰∏≠ÁöÑÁ°¨ÁºñÁ†ÅÂØÜÈí•
        if grep -r "password\|secret\|key\|token" terraform/*.tf | grep -v "variable\|data\|local" | grep "="; then
          echo "‚ö†Ô∏è  Potential hardcoded secrets found in Terraform files"
          exit 1
        fi

    - name: Validate Terraform naming conventions
      run: |
        # Ê£ÄÊü•ÂëΩÂêçÁ∫¶ÂÆö
        cd terraform
        
        # Ê£ÄÊü•ËµÑÊ∫êÂëΩÂêç
        grep -r "resource \"" . | grep -v "_" && {
          echo "‚ùå Terraform resources should use snake_case naming"
          exit 1
        }
        
        # Ê£ÄÊü•ÂèòÈáèÂëΩÂêç
        grep -r "variable \"" . | grep "[A-Z]" && {
          echo "‚ùå Terraform variables should use lowercase naming"
          exit 1
        }

    - name: Check Terraform provider versions
      run: |
        # Á°Æ‰øùproviderÁâàÊú¨Ë¢´ÈîÅÂÆö
        cd terraform
        if ! grep -r "required_providers" . | grep -q "version"; then
          echo "‚ö†Ô∏è  Terraform provider versions should be pinned for reproducibility"
        fi

  # Kubernetes ÂÆâÂÖ®Ê£ÄÊü•
  kubernetes-security:
    runs-on: ubuntu-latest
    if: hashFiles('k8s/**/*.yaml') != '' || hashFiles('k8s/**/*.yml') != ''
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.29.0'

    - name: Validate Kubernetes manifests
      run: |
        # È™åËØÅÊâÄÊúâKubernetes YAMLÊñá‰ª∂
        find k8s/ -name "*.yaml" -o -name "*.yml" | while read file; do
          echo "Validating $file..."
          kubectl apply --dry-run=client -f "$file"
          if [ $? -ne 0 ]; then
            echo "‚ùå Invalid Kubernetes manifest: $file"
            exit 1
          fi
        done

    - name: Run Polaris security scan
      uses: fairwindsops/polaris-action@v1
      with:
        config: |
          checks:
            cpuLimitsMissing: warning
            memoryLimitsMissing: warning
            runAsNonRoot: error
            runAsPrivileged: error
            dangerousCapabilities: error
            hostPIDSet: error
            hostNetworkSet: error
            hostIPCSet: error
            notReadOnlyRootFilesystem: warning
            privilegeEscalationAllowed: error

    - name: Run Kubesec Security Scan
      run: |
        # ‰∏ãËΩΩÂπ∂ËøêË°åkubesec
        wget https://github.com/controlplaneio/kubesec/releases/download/v2.11.5/kubesec_linux_amd64.tar.gz
        tar -xzf kubesec_linux_amd64.tar.gz
        chmod +x kubesec
        
        # Êâ´ÊèèÊâÄÊúâKubernetesÊñá‰ª∂
        find k8s/ -name "*.yaml" -o -name "*.yml" | while read file; do
          echo "Scanning $file with Kubesec..."
          ./kubesec scan "$file" > "${file}.kubesec.json"
          
          # Ê£ÄÊü•ÂàÜÊï∞ÊòØÂê¶Ëøá‰Ωé
          SCORE=$(jq -r '.[].score' "${file}.kubesec.json" | head -n 1)
          if [ "$SCORE" -lt 5 ]; then
            echo "‚ùå Low security score ($SCORE) for $file"
            exit 1
          fi
        done

    - name: Check for privileged containers
      run: |
        # Ê£ÄÊü•ÁâπÊùÉÂÆπÂô®
        find k8s/ -name "*.yaml" -o -name "*.yml" | xargs grep -l "privileged:\s*true" && {
          echo "‚ùå Privileged containers found - security risk!"
          exit 1
        }

    - name: Check for host network access
      run: |
        # Ê£ÄÊü•‰∏ªÊú∫ÁΩëÁªúËÆøÈóÆ
        find k8s/ -name "*.yaml" -o -name "*.yml" | xargs grep -l "hostNetwork:\s*true" && {
          echo "‚ùå Host network access found - security risk!"
          exit 1
        }

    - name: Validate resource limits
      run: |
        # Ê£ÄÊü•ËµÑÊ∫êÈôêÂà∂
        find k8s/ -name "*.yaml" -o -name "*.yml" | while read file; do
          if grep -q "kind: Deployment\|kind: StatefulSet\|kind: DaemonSet" "$file"; then
            if ! grep -A 20 "containers:" "$file" | grep -q "resources:"; then
              echo "‚ö†Ô∏è  Resource limits not defined in $file"
            fi
          fi
        done

    - name: Check for latest image tags
      run: |
        # Ê£ÄÊü•ÊòØÂê¶‰ΩøÁî®‰∫ÜlatestÊ†áÁ≠æ
        find k8s/ -name "*.yaml" -o -name "*.yml" | xargs grep -l "image:.*:latest" && {
          echo "‚ö†Ô∏è  'latest' image tags found - consider using specific versions"
        }

  # Helm Chart ÂÆâÂÖ®Ê£ÄÊü•
  helm-security:
    runs-on: ubuntu-latest
    if: hashFiles('helm/**/*.yaml') != '' || hashFiles('helm/**/*.yml') != ''
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Helm
      uses: azure/setup-helm@v3
      with:
        version: ${{ env.HELM_VERSION }}

    - name: Lint Helm charts
      run: |
        # Ê£ÄÊü•ÊâÄÊúâHelm chart
        find helm/ -name Chart.yaml | while read chart; do
          CHART_DIR=$(dirname "$chart")
          echo "Linting Helm chart in $CHART_DIR..."
          helm lint "$CHART_DIR"
          if [ $? -ne 0 ]; then
            echo "‚ùå Helm chart linting failed for $CHART_DIR"
            exit 1
          fi
        done

    - name: Validate Helm chart schema
      run: |
        # È™åËØÅvaluesÊñá‰ª∂
        find helm/ -name values.yaml | while read values; do
          CHART_DIR=$(dirname "$values")
          if [ -f "$CHART_DIR/values.schema.json" ]; then
            echo "Validating values against schema for $CHART_DIR..."
            # ËøôÈáåÂèØ‰ª•Ê∑ªÂä†JSON schemaÈ™åËØÅ
          fi
        done

    - name: Run Helm security scan
      run: |
        # ‰ΩøÁî®helm-secretsÊ£ÄÊü•Âä†ÂØÜÂÄº
        if command -v helm-secrets >/dev/null 2>&1; then
          find helm/ -name secrets.yaml | while read secrets; do
            echo "Checking encrypted secrets in $secrets..."
            helm secrets view "$secrets" >/dev/null
          done
        fi

    - name: Check Helm chart security
      run: |
        # ‰ΩøÁî®helm-templateÊ∏≤ÊüìÂπ∂Ê£ÄÊü•
        find helm/ -name Chart.yaml | while read chart; do
          CHART_DIR=$(dirname "$chart")
          echo "Security checking Helm chart in $CHART_DIR..."
          
          # Ê∏≤ÊüìÊ®°Êùø
          helm template test-release "$CHART_DIR" > rendered.yaml
          
          # Ê£ÄÊü•Ê∏≤ÊüìÂêéÁöÑYAMLÂÆâÂÖ®ÊÄß
          if grep -q "runAsUser: 0" rendered.yaml; then
            echo "‚ùå Container running as root user found"
            exit 1
          fi
          
          if grep -q "privileged: true" rendered.yaml; then
            echo "‚ùå Privileged container found"
            exit 1
          fi
          
          rm rendered.yaml
        done

  # Docker Compose ÂÆâÂÖ®Ê£ÄÊü•
  docker-compose-security:
    runs-on: ubuntu-latest
    if: hashFiles('docker-compose.yml') != ''
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate Docker Compose
      run: |
        # Âü∫Êú¨ËØ≠Ê≥ïÈ™åËØÅ
        docker-compose config > /dev/null
        if [ $? -ne 0 ]; then
          echo "‚ùå Invalid Docker Compose file"
          exit 1
        fi

    - name: Check Docker Compose security
      run: |
        # Ê£ÄÊü•ÂÆâÂÖ®ÊúÄ‰Ω≥ÂÆûË∑µ
        
        # Ê£ÄÊü•ÊòØÂê¶‰ΩøÁî®‰∫ÜrootÁî®Êà∑
        if grep -q "user:.*root" docker-compose.yml; then
          echo "‚ùå Root user specified in docker-compose.yml"
          exit 1
        fi
        
        # Ê£ÄÊü•ÊòØÂê¶‰ΩøÁî®‰∫ÜÁâπÊùÉÊ®°Âºè
        if grep -q "privileged:.*true" docker-compose.yml; then
          echo "‚ùå Privileged mode enabled in docker-compose.yml"
          exit 1
        fi
        
        # Ê£ÄÊü•ËµÑÊ∫êÈôêÂà∂
        if ! grep -q "deploy:" docker-compose.yml; then
          echo "‚ö†Ô∏è  Resource limits not specified - consider adding deploy section"
        fi
        
        # Ê£ÄÊü•ÁΩëÁªúÈÖçÁΩÆ
        if grep -q "network_mode:.*host" docker-compose.yml; then
          echo "‚ö†Ô∏è  Host network mode used - ensure this is necessary"
        fi

    - name: Validate Docker Compose secrets
      run: |
        # Ê£ÄÊü•ÊòØÂê¶Ê≠£Á°Æ‰ΩøÁî®secrets
        if grep -q "password\|secret\|key" docker-compose.yml && ! grep -q "secrets:" docker-compose.yml; then
          echo "‚ö†Ô∏è  Potential secrets found - consider using Docker secrets"
        fi

  # Âü∫Á°ÄËÆæÊñΩÊàêÊú¨‰º∞ÁÆó
  infrastructure-cost:
    runs-on: ubuntu-latest
    if: hashFiles('terraform/**/*.tf') != ''
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}

    - name: Install Infracost
      run: |
        curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh

    - name: Generate cost estimate
      env:
        INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
      run: |
        cd terraform
        terraform init -backend=false
        
        # ÁîüÊàêÊàêÊú¨‰º∞ÁÆó
        infracost breakdown --path . \
          --format json \
          --out-file /tmp/infracost.json
        
        # ÊòæÁ§∫ÊàêÊú¨‰º∞ÁÆó
        infracost output --path /tmp/infracost.json --format table
        
        # Ê£ÄÊü•ÊàêÊú¨ÊòØÂê¶Ë∂ÖËøáÈòàÂÄº
        MONTHLY_COST=$(infracost output --path /tmp/infracost.json --format json | jq -r '.totalMonthlyCost')
        MAX_COST=100  # ÊúÄÂ§ß$100/Êúà
        
        if (( $(echo "$MONTHLY_COST > $MAX_COST" | bc -l) )); then
          echo "‚ùå Estimated monthly cost ($$MONTHLY_COST) exceeds maximum allowed ($$MAX_COST)"
          exit 1
        fi

    - name: Comment PR with cost estimate
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const infracostData = JSON.parse(fs.readFileSync('/tmp/infracost.json', 'utf8'));
          
          const comment = `## üí∞ Infrastructure Cost Estimate
          
          **Estimated Monthly Cost**: $${infracostData.totalMonthlyCost}
          
          <details>
          <summary>Cost Breakdown</summary>
          
          \`\`\`
          ${JSON.stringify(infracostData.projects[0].breakdown.resources, null, 2)}
          \`\`\`
          </details>
          
          *Powered by Infracost*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });