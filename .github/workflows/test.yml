name: test

on:
  push:
    branches:
      - main
      - master
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json
      - run: npm ci
      - name: Repo sanity (no root junk)
        run: npm run verify:repo-sanity
      - name: File line-limit gate (<500)
        run: npm run verify:file-line-limit
      - name: Ensure release llms module
        run: BUILD_MODE=release npm run llmswitch:ensure
      - name: Build (release)
        env:
          BUILD_MODE: release
          # Prevent build scripts from mutating version files in CI.
          ROUTECODEX_SKIP_AUTO_BUMP: "1"
        run: npm run build:min
      - name: Run host tests
        env:
          ROUTECODEX_JEST_USE_NPM_LLMS: "1"
          # Prevent test-triggered builds (mock regressions) from auto-bumping version files in CI.
          ROUTECODEX_SKIP_AUTO_BUMP: "1"
        run: npm run test:ci

  coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json
      - run: npm ci
      - name: Repo sanity (no root junk)
        run: npm run verify:repo-sanity
      - name: File line-limit gate (<500)
        run: npm run verify:file-line-limit
      - name: Ensure release llms module
        run: BUILD_MODE=release npm run llmswitch:ensure
      - name: Build (release)
        env:
          BUILD_MODE: release
          ROUTECODEX_SKIP_AUTO_BUMP: "1"
        run: npm run build:min
      - name: Run CI coverage (jest-only)
        env:
          ROUTECODEX_JEST_USE_NPM_LLMS: "1"
          ROUTECODEX_SKIP_AUTO_BUMP: "1"
          ROUTECODEX_CI_MAX_WORKERS: "2"
        run: npm run test:ci:coverage
      - name: Coverage summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [[ -f coverage/coverage-summary.json ]]; then
            node -e 'const fs=require("fs");const s=JSON.parse(fs.readFileSync("coverage/coverage-summary.json","utf8"));const t=s.total||{};const pct=(x)=>((x&&typeof x.pct==="number")?x.pct:0);console.log(`lines: ${pct(t.lines)}%`);console.log(`branches: ${pct(t.branches)}%`);console.log(`functions: ${pct(t.functions)}%`);console.log(`statements: ${pct(t.statements)}%`);'
          else
            echo "missing coverage/coverage-summary.json"
            ls -la coverage || true
          fi
