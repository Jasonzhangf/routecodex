name: Advanced Deployment Strategies

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      deployment_strategy:
        description: 'Deployment strategy'
        required: true
        type: choice
        options: [ 'blue-green', 'canary', 'rolling', 'recreate' ]
        default: 'canary'
      canary_percentage:
        description: 'Canary percentage (for canary deployment)'
        required: false
        type: number
        default: 10
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options: [ 'staging', 'production' ]
        default: 'staging'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DEPLOYMENT_TIMEOUT: 600  # 10åˆ†é’Ÿè¶…æ—¶

jobs:
  # éƒ¨ç½²å‰åˆ†æžå’Œå‡†å¤‡
  deployment-analysis:
    runs-on: ubuntu-latest
    outputs:
      strategy: ${{ steps.analyze.outputs.strategy }}
      risk-level: ${{ steps.analyze.outputs.risk-level }}
      rollback-enabled: ${{ steps.analyze.outputs.rollback-enabled }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Analyze deployment risk
      id: analyze
      run: |
        # åˆ†æžéƒ¨ç½²é£Žé™©
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | wc -l)
        
        if [ $CHANGED_FILES -gt 50 ]; then
          RISK_LEVEL="high"
          STRATEGY="canary"
        elif [ $CHANGED_FILES -gt 20 ]; then
          RISK_LEVEL="medium"
          STRATEGY="rolling"
        else
          RISK_LEVEL="low"
          STRATEGY="rolling"
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ç ´åæ€§å˜æ›´
        if git log --oneline HEAD~1 HEAD | grep -i "breaking\|major\|incompatible"; then
          RISK_LEVEL="high"
          STRATEGY="blue-green"
        fi
        
        echo "strategy=${STRATEGY}" >> $GITHUB_OUTPUT
        echo "risk-level=${RISK_LEVEL}" >> $GITHUB_OUTPUT
        echo "rollback-enabled=true" >> $GITHUB_OUTPUT
        
        echo "Deployment analysis completed:"
        echo "- Strategy: ${STRATEGY}"
        echo "- Risk Level: ${RISK_LEVEL}"
        echo "- Rollback Enabled: true"

    - name: Generate deployment manifest
      run: |
        # ç”Ÿæˆéƒ¨ç½²æ¸…å•
        cat > deployment-manifest.json << EOF
        {
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "commit": "${{ github.sha }}",
          "version": "$(node -p "require('./package.json').version")",
          "strategy": "${{ steps.analyze.outputs.strategy }}",
          "risk-level": "${{ steps.analyze.outputs.risk-level }}",
          "environment": "${{ github.event.inputs.environment || 'staging' }}",
          "triggered-by": "${{ github.actor }}"
        }
        EOF
        
        cat deployment-manifest.json

  # æž„å»ºå’Œå‡†å¤‡å®¹å™¨é•œåƒ
  build-and-prepare:
    runs-on: ubuntu-latest
    needs: [deployment-analysis]
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Sign container image
      uses: sigstore/cosign-installer@v3
      run: |
        cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  # è“ç»¿éƒ¨ç½²
  blue-green-deployment:
    runs-on: ubuntu-latest
    needs: [deployment-analysis, build-and-prepare]
    if: |
      (github.event.inputs.deployment_strategy == 'blue-green') ||
      (needs.deployment-analysis.outputs.strategy == 'blue-green')
    environment:
      name: ${{ github.event.inputs.environment }}-blue-green
      url: https://${{ github.event.inputs.environment }}.routecodex.com
    
    steps:
    - name: Deploy Blue Environment
      run: |
        echo "Deploying to BLUE environment..."
        # éƒ¨ç½²è“è‰²çŽ¯å¢ƒ
        helm upgrade --install routecodex-blue ./helm/routecodex \
          --namespace ${{ github.event.inputs.environment }} \
          --set image.tag=${{ github.sha }} \
          --set deployment.color=blue \
          --set ingress.enabled=false \
          --wait --timeout=${{ env.DEPLOYMENT_TIMEOUT }}s

    - name: Health Check Blue Environment
      run: |
        echo "Health checking BLUE environment..."
        # ç­‰å¾…è“è‰²çŽ¯å¢ƒå¥åº·
        for i in {1..30}; do
          if curl -f http://blue.${{ github.event.inputs.environment }}.routecodex.com/health; then
            echo "âœ… BLUE environment is healthy"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "âŒ BLUE environment health check failed"
            exit 1
          fi
          sleep 10
        done

    - name: Switch Traffic to Blue
      run: |
        echo "Switching traffic to BLUE environment..."
        # åˆ‡æ¢æµé‡åˆ°è“è‰²çŽ¯å¢ƒ
        kubectl patch service routecodex-service \
          -n ${{ github.event.inputs.environment }} \
          -p '{"spec":{"selector":{"color":"blue"}}}'

    - name: Deploy Green Environment (Backup)
      run: |
        echo "Deploying GREEN environment as backup..."
        # éƒ¨ç½²ç»¿è‰²çŽ¯å¢ƒä½œä¸ºå¤‡ä»½
        helm upgrade --install routecodex-green ./helm/routecodex \
          --namespace ${{ github.event.inputs.environment }} \
          --set image.tag=${{ needs.build-and-prepare.outputs.image-tag }} \
          --set deployment.color=green \
          --set ingress.enabled=false \
          --wait --timeout=${{ env.DEPLOYMENT_TIMEOUT }}s

    - name: Validate Deployment
      run: |
        echo "Validating blue-green deployment..."
        # éªŒè¯éƒ¨ç½²æˆåŠŸ
        TRAFFIC_CHECK=$(kubectl get service routecodex-service -n ${{ github.event.inputs.environment }} -o jsonpath='{.spec.selector.color}')
        if [ "$TRAFFIC_CHECK" != "blue" ]; then
          echo "âŒ Traffic not properly switched to blue environment"
          exit 1
        fi
        echo "âœ… Blue-green deployment successful"

  # é‡‘ä¸é›€éƒ¨ç½²
  canary-deployment:
    runs-on: ubuntu-latest
    needs: [deployment-analysis, build-and-prepare]
    if: |
      (github.event.inputs.deployment_strategy == 'canary') ||
      (needs.deployment-analysis.outputs.strategy == 'canary')
    environment:
      name: ${{ github.event.inputs.environment }}-canary
      url: https://${{ github.event.inputs.environment }}.routecodex.com
    
    steps:
    - name: Deploy Canary Version
      run: |
        echo "Deploying canary version (${{ github.event.inputs.canary_percentage || 10 }}%)..."
        CANARY_WEIGHT=${{ github.event.inputs.canary_percentage || 10 }}
        STABLE_WEIGHT=$((100 - CANARY_WEIGHT))
        
        # éƒ¨ç½²é‡‘ä¸é›€ç‰ˆæœ¬
        helm upgrade --install routecodex-canary ./helm/routecodex \
          --namespace ${{ github.event.inputs.environment }} \
          --set image.tag=${{ github.sha }} \
          --set deployment.canary=true \
          --set ingress.canary.weight=$CANARY_WEIGHT \
          --set replicaCount=1 \
          --wait --timeout=${{ env.DEPLOYMENT_TIMEOUT }}s

    - name: Monitor Canary Metrics
      run: |
        echo "Monitoring canary metrics for 5 minutes..."
        START_TIME=$(date +%s)
        
        while true; do
          CURRENT_TIME=$(date +%s)
          ELAPSED=$((CURRENT_TIME - START_TIME))
          
          if [ $ELAPSED -gt 300 ]; then  # 5åˆ†é’Ÿç›‘æŽ§
            break
          fi
          
          # èŽ·å–é‡‘ä¸é›€æŒ‡æ ‡
          CANARY_REQUESTS=$(kubectl logs -n ${{ github.event.inputs.environment }} -l app=routecodex,canary=true --tail=100 | wc -l)
          CANARY_ERRORS=$(kubectl logs -n ${{ github.event.inputs.environment }} -l app=routecodex,canary=true --tail=100 | grep -i error | wc -l)
          
          ERROR_RATE=$((CANARY_ERRORS * 100 / CANARY_REQUESTS))
          
          echo "Canary error rate: ${ERROR_RATE}%"
          
          if [ $ERROR_RATE -gt 5 ]; then
            echo "âŒ Canary error rate too high (${ERROR_RATE}%) - rolling back"
            exit 1
          fi
          
          sleep 30
        done

    - name: Promote Canary
      run: |
        echo "Promoting canary to full deployment..."
        # é€æ­¥å¢žåŠ é‡‘ä¸é›€æµé‡
        for weight in 25 50 75 100; do
          kubectl patch ingress routecodex-ingress \
            -n ${{ github.event.inputs.environment }} \
            --type='json' \
            -p="[{'op': 'replace', 'path': '/metadata/annotations/nginx.ingress.kubernetes.io~1canary-weight', 'value': '$weight'}]"
          
          echo "Canary traffic increased to $weight%"
          sleep 60
        done

    - name: Complete Canary Deployment
      run: |
        echo "Completing canary deployment..."
        # ç§»é™¤é‡‘ä¸é›€æ ‡ç­¾ï¼Œæˆä¸ºä¸»è¦éƒ¨ç½²
        helm upgrade --install routecodex ./helm/routecodex \
          --namespace ${{ github.event.inputs.environment }} \
          --set image.tag=${{ github.sha }} \
          --set deployment.canary=false \
          --wait --timeout=${{ env.DEPLOYMENT_TIMEOUT }}s

  # æ»šåŠ¨éƒ¨ç½²
  rolling-deployment:
    runs-on: ubuntu-latest
    needs: [deployment-analysis, build-and-prepare]
    if: |
      (github.event.inputs.deployment_strategy == 'rolling') ||
      (needs.deployment-analysis.outputs.strategy == 'rolling')
    environment:
      name: ${{ github.event.inputs.environment }}-rolling
      url: https://${{ github.event.inputs.environment }}.routecodex.com
    
    strategy:
      matrix:
        batch: [1, 2, 3]  # åˆ†3æ‰¹æ»šåŠ¨æ›´æ–°
    
    steps:
    - name: Rolling Update Batch ${{ matrix.batch }}
      run: |
        echo "Performing rolling update - batch ${{ matrix.batch }}/3"
        
        # èŽ·å–å½“å‰éƒ¨ç½²çŠ¶æ€
        CURRENT_REPLICAS=$(kubectl get deployment routecodex -n ${{ github.event.inputs.environment }} -o jsonpath='{.spec.replicas}')
        BATCH_SIZE=$((CURRENT_REPLICAS / 3))
        
        if [ $BATCH_SIZE -lt 1 ]; then
          BATCH_SIZE=1
        fi
        
        echo "Updating $BATCH_SIZE replicas in batch ${{ matrix.batch }}"
        
        # æ‰§è¡Œæ»šåŠ¨æ›´æ–°
        kubectl patch deployment routecodex \
          -n ${{ github.event.inputs.environment }} \
          -p '{"spec":{"template":{"spec":{"containers":[{"name":"routecodex","image":"${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"}]}}}}'
        
        # ç­‰å¾…æ»šåŠ¨æ›´æ–°å®Œæˆ
        kubectl rollout status deployment/routecodex \
          -n ${{ github.event.inputs.environment }} \
          --timeout=${{ env.DEPLOYMENT_TIMEOUT }}s

    - name: Health Check After Batch
      run: |
        echo "Health checking after batch ${{ matrix.batch }}..."
        
        # æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
        ROLLOUT_STATUS=$(kubectl rollout status deployment/routecodex -n ${{ github.event.inputs.environment }} --timeout=30s)
        
        if [ $? -eq 0 ]; then
          echo "âœ… Rolling update batch ${{ matrix.batch }} completed successfully"
        else
          echo "âŒ Rolling update batch ${{ matrix.batch }} failed"
          exit 1
        fi
        
        # ç­‰å¾…ä¸€æ®µæ—¶é—´å†å¼€å§‹ä¸‹ä¸€æ‰¹
        if [ ${{ matrix.batch }} -lt 3 ]; then
          echo "Waiting before next batch..."
          sleep 60
        fi

  # éƒ¨ç½²åŽéªŒè¯å’Œç›‘æŽ§
  post-deployment-validation:
    runs-on: ubuntu-latest
    needs: [blue-green-deployment, canary-deployment, rolling-deployment]
    if: always() && (needs.blue-green-deployment.result == 'success' || needs.canary-deployment.result == 'success' || needs.rolling-deployment.result == 'success')
    
    steps:
    - name: Comprehensive Health Check
      run: |
        echo "Performing comprehensive health check..."
        
        # æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€
        for i in {1..10}; do
          if curl -f https://${{ github.event.inputs.environment }}.routecodex.com/health; then
            echo "âœ… Application health check passed"
            break
          fi
          if [ $i -eq 10 ]; then
            echo "âŒ Application health check failed"
            exit 1
          fi
          sleep 30
        done

    - name: Performance Validation
      run: |
        echo "Validating performance after deployment..."
        
        # æµ‹è¯•å…³é”®ç«¯ç‚¹æ€§èƒ½
        START_TIME=$(date +%s%N)
        curl -s https://${{ github.event.inputs.environment }}.routecodex.com/health > /dev/null
        END_TIME=$(date +%s%N)
        
        RESPONSE_TIME=$((($END_TIME - $START_TIME) / 1000000))
        echo "Health check response time: ${RESPONSE_TIME}ms"
        
        if [ $RESPONSE_TIME -gt 5000 ]; then
          echo "âŒ Response time too high: ${RESPONSE_TIME}ms"
          exit 1
        fi

    - name: Error Rate Monitoring
      run: |
        echo "Monitoring error rates..."
        
        # ç›‘æŽ§5åˆ†é’Ÿå†…çš„é”™è¯¯çŽ‡
        START_TIME=$(date +%s)
        ERROR_COUNT=0
        TOTAL_REQUESTS=0
        
        while true; do
          CURRENT_TIME=$(date +%s)
          ELAPSED=$((CURRENT_TIME - START_TIME))
          
          if [ $ELAPSED -gt 300 ]; then  # 5åˆ†é’Ÿ
            break
          fi
          
          # æ¨¡æ‹Ÿè¯·æ±‚å¹¶æ£€æŸ¥å“åº”
          RESPONSE_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ github.event.inputs.environment }}.routecodex.com/health)
          TOTAL_REQUESTS=$((TOTAL_REQUESTS + 1))
          
          if [ "$RESPONSE_CODE" != "200" ]; then
            ERROR_COUNT=$((ERROR_COUNT + 1))
          fi
          
          sleep 10
        done
        
        ERROR_RATE=$((ERROR_COUNT * 100 / TOTAL_REQUESTS))
        echo "Error rate: ${ERROR_RATE}%"
        
        if [ $ERROR_RATE -gt 5 ]; then
          echo "âŒ Error rate too high: ${ERROR_RATE}%"
          exit 1
        fi

    - name: Resource Usage Check
      run: |
        echo "Checking resource usage..."
        
        # èŽ·å–éƒ¨ç½²çš„Podåˆ—è¡¨
        PODS=$(kubectl get pods -n ${{ github.event.inputs.environment }} -l app=routecodex -o jsonpath='{.items[*].metadata.name}')
        
        for pod in $PODS; do
          echo "Checking resource usage for pod: $pod"
          
          # èŽ·å–CPUä½¿ç”¨çŽ‡
          CPU_USAGE=$(kubectl top pod $pod -n ${{ github.event.inputs.environment }} --no-headers | awk '{print $2}' | sed 's/m//')
          
          # èŽ·å–å†…å­˜ä½¿ç”¨çŽ‡
          MEMORY_USAGE=$(kubectl top pod $pod -n ${{ github.event.inputs.environment }} --no-headers | awk '{print $3}' | sed 's/Mi//')
          
          echo "Pod $pod - CPU: ${CPU_USAGE}m, Memory: ${MEMORY_USAGE}Mi"
          
          # æ£€æŸ¥æ˜¯å¦è¶…è¿‡é˜ˆå€¼
          if [ $CPU_USAGE -gt 500 ]; then
            echo "âš ï¸  High CPU usage detected: ${CPU_USAGE}m"
          fi
          
          if [ $MEMORY_USAGE -gt 512 ]; then
            echo "âš ï¸  High memory usage detected: ${MEMORY_USAGE}Mi"
          fi
        done

    - name: Generate Deployment Report
      run: |
        echo "Generating deployment report..."
        
        cat > deployment-report.md << EOF
        # Deployment Report
        
        **Deployment ID**: ${{ github.sha }}
        **Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
        **Strategy**: ${{ needs.deployment-analysis.outputs.strategy }}
        **Environment**: ${{ github.event.inputs.environment }}
        **Status**: âœ… SUCCESS
        
        ## Deployment Details
        - **Image**: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        - **Duration**: ${{ env.DEPLOYMENT_TIMEOUT }}s timeout
        - **Risk Level**: ${{ needs.deployment-analysis.outputs.risk-level }}
        
        ## Validation Results
        - âœ… Health checks passed
        - âœ… Performance within acceptable limits
        - âœ… Error rate below threshold
        - âœ… Resource usage normal
        
        ## Next Steps
        - Monitor application for 24 hours
        - Review performance metrics
        - Check error logs
        
        EOF
        
        cat deployment-report.md

    - name: Upload Deployment Report
      uses: actions/upload-artifact@v3
      with:
        name: deployment-report-${{ github.sha }}
        path: deployment-report.md
        retention-days: 90

  # è‡ªåŠ¨å›žæ»šï¼ˆå¦‚æžœéƒ¨ç½²å¤±è´¥ï¼‰
  auto-rollback:
    runs-on: ubuntu-latest
    needs: [post-deployment-validation]
    if: failure()
    
    steps:
    - name: Initiate Rollback
      run: |
        echo "âš ï¸  Deployment validation failed - initiating rollback..."
        
        # èŽ·å–ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
        PREVIOUS_REVISION=$(kubectl rollout history deployment/routecodex -n ${{ github.event.inputs.environment }} | tail -n 2 | head -n 1 | awk '{print $1}')
        
        echo "Rolling back to revision $PREVIOUS_REVISION..."
        
        # æ‰§è¡Œå›žæ»š
        kubectl rollout undo deployment/routecodex \
          -n ${{ github.event.inputs.environment }} \
          --to-revision=$PREVIOUS_REVISION
        
        # ç­‰å¾…å›žæ»šå®Œæˆ
        kubectl rollout status deployment/routecodex \
          -n ${{ github.event.inputs.environment }} \
          --timeout=300s
        
        echo "âœ… Rollback completed successfully"

    - name: Send Rollback Alert
      run: |
        echo "ðŸš¨ DEPLOYMENT ROLLBACK INITIATED"
        echo "Deployment SHA: ${{ github.sha }}"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Reason: Deployment validation failed"
        
        # è¿™é‡Œå¯ä»¥é›†æˆé€šçŸ¥ç³»ç»Ÿï¼ˆSlack, Teams, etc.ï¼‰
        
  # æ¸…ç†å’Œå½’æ¡£
  cleanup:
    runs-on: ubuntu-latest
    needs: [post-deployment-validation, auto-rollback]
    if: always()
    
    steps:
    - name: Cleanup Old Deployments
      run: |
        echo "Cleaning up old deployments..."
        
        # ä¿ç•™æœ€è¿‘5ä¸ªç‰ˆæœ¬ï¼Œåˆ é™¤æ—§çš„
        kubectl get deployments -n ${{ github.event.inputs.environment }} -o name | \
          grep -v "routecodex$" | \
          head -n -5 | \
          xargs -r kubectl delete -n ${{ github.event.inputs.environment }}
        
        echo "Cleanup completed"