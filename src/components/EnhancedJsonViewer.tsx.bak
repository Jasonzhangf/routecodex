import React, { useState, useCallback, useMemo } from 'react';
import { MessageTruncator, type TruncationOptions, type TruncationResult } from '../utils/message-truncator';

interface EnhancedJsonViewerProps {
  data: any;
  title?: string;
  initialExpanded?: boolean;
  enableTruncation?: boolean;
  truncationOptions?: TruncationOptions;
  onTruncationChange?: (result: TruncationResult) => void;
  showTruncationControls?: boolean;
  theme?: 'light' | 'dark';
}

export const EnhancedJsonViewer: React.FC<EnhancedJsonViewerProps> = ({
  data,
  title = 'JSON Data',
  initialExpanded = false,
  enableTruncation = true,
  truncationOptions,
  onTruncationChange,
  showTruncationControls = true,
  theme = 'light'
}) => {
  const [expandedPaths, setExpandedPaths] = useState<Set<string>>(new Set());
  const [isFullyExpanded, setIsFullyExpanded] = useState(initialExpanded);
  const [customTruncationOptions, setCustomTruncationOptions] = useState<TruncationOptions>(truncationOptions || {});

  // æ™ºèƒ½æˆªæ–­å»ºè®®
  const truncationSuggestions = useMemo(() => {
    if (!enableTruncation) return null;
    return MessageTruncator.getTruncationSuggestions(data);
  }, [data, enableTruncation]);

  // åº”ç”¨æˆªæ–­
  const truncatedData = useMemo(() => {
    if (!enableTruncation) return data;

    const options = {
      ...truncationSuggestions?.recommended,
      ...customTruncationOptions
    };

    const result = MessageTruncator.truncate(data, options);
    onTruncationChange?.(result);
    return result.data;
  }, [data, enableTruncation, truncationSuggestions, customTruncationOptions, onTruncationChange]);

  // è·å–æˆªæ–­ä¿¡æ¯
  const truncationInfo = useMemo(() => {
    if (!enableTruncation) return null;
    const result = MessageTruncator.truncate(data, customTruncationOptions || {});
    return result.truncationInfo;
  }, [data, enableTruncation, customTruncationOptions]);

  // å¤§å‹å†…å®¹æ£€æµ‹
  const largeContentInfo = useMemo(() => {
    return MessageTruncator.detectLargeContent(data);
  }, [data]);

  // åˆ‡æ¢è·¯å¾„å±•å¼€çŠ¶æ€
  const togglePath = useCallback((path: string) => {
    setExpandedPaths(prev => {
      const newSet = new Set(prev);
      if (newSet.has(path)) {
        newSet.delete(path);
      } else {
        newSet.add(path);
      }
      return newSet;
    });
  }, []);

  // å±•å¼€æ‰€æœ‰è·¯å¾„
  const expandAll = useCallback(() => {
    const allPaths = new Set<string>();
    const collectPaths = (obj: any, path: string = '') => {
      if (typeof obj === 'object' && obj !== null) {
        if (Array.isArray(obj)) {
          obj.forEach((item, index) => {
            collectPaths(item, `${path}[${index}]`);
          });
        } else {
          Object.keys(obj).forEach(key => {
            const newPath = path ? `${path}.${key}` : key;
            allPaths.add(newPath);
            collectPaths(obj[key], newPath);
          });
        }
      }
    };
    collectPaths(truncatedData);
    setExpandedPaths(allPaths);
    setIsFullyExpanded(true);
  }, [truncatedData]);

  // æŠ˜å æ‰€æœ‰è·¯å¾„
  const collapseAll = useCallback(() => {
    setExpandedPaths(new Set());
    setIsFullyExpanded(false);
  }, []);

  // æ¸²æŸ“JSONå€¼
  const renderJsonValue = useCallback((value: any, path: string, level: number = 0): React.ReactNode => {
    const isExpanded = expandedPaths.has(path);
    const isArray = Array.isArray(value);
    const isObject = typeof value === 'object' && value !== null && !isArray;

    // å¤„ç†ç‰¹æ®Šæˆªæ–­æ ‡è®°
    if (typeof value === 'string' && value.includes('[TRUNCATED:')) {
      const parts = value.split('[TRUNCATED:');
      const content = parts[0];
      const truncationInfo = parts[1]?.replace(']', '') || '';

      return (
        <div className="json-truncated" style={{ marginLeft: level * 20 }}>
          <div className="json-content truncated">
            <pre>{content}</pre>
          </div>
          <div className="truncation-warning">
            âš ï¸ {truncationInfo}
          </div>
        </div>
      );
    }

    // å¤„ç†çœç•¥æ ‡è®°
    if (typeof value === 'string' && (value.includes('[... omitted') || value.includes('[... omitted items'))) {
      return (
        <div className="json-omitted" style={{ marginLeft: level * 20 }}>
          <span className="omitted-marker">ğŸ“¦ {value}</span>
        </div>
      );
    }

    // å¤„ç†å¾ªç¯å¼•ç”¨å’Œæ·±åº¦é™åˆ¶
    if (typeof value === 'string' && (value.includes('[Circular Reference]') || value.includes('[Max Depth Exceeded]'))) {
      return (
        <div className="json-special" style={{ marginLeft: level * 20 }}>
          <span className="special-marker">ğŸ”— {value}</span>
        </div>
      );
    }

    if (isObject || isArray) {
      const itemCount = Object.keys(value).length;
      const canExpand = itemCount > 0;

      return (
        <div className="json-object" style={{ marginLeft: level * 20 }}>
          <div
            className={`json-toggle ${canExpand ? 'clickable' : ''}`}
            onClick={() => canExpand && togglePath(path)}
          >
            {canExpand && (
              <span className="toggle-icon">
                {isExpanded ? 'â–¼' : 'â–¶'}
              </span>
            )}
            <span className="json-key">
              {path.split('.').pop()?.replace(/\[\d+\]$/, '')}:
            </span>
            <span className="json-type">
              {isArray ? `Array[${itemCount}]` : `Object{${itemCount}}`}
            </span>
            {canExpand && (
              <span className="toggle-hint">
                ({isExpanded ? 'æ”¶èµ·' : 'å±•å¼€'})
              </span>
            )}
          </div>

          {isExpanded && (
            <div className="json-children">
              {Object.entries(value).map(([key, val]) => (
                <div key={key}>
                  {renderJsonValue(val, `${path}.${key}`, level + 1)}
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // åŸºæœ¬ç±»å‹å€¼
    return (
      <div className="json-value" style={{ marginLeft: level * 20 }}>
        <span className="json-key">
          {path.split('.').pop()?.replace(/\[\d+\]$/, '')}:
        </span>
        <span className={`json-value-${typeof value}`}>
          {typeof value === 'string' && value.length > 100
            ? `${value.substring(0, 100)}...`
            : JSON.stringify(value)
          }
        </span>
        {typeof value === 'string' && value.length > 100 && (
          <span className="length-info">
            ({value.length} chars)
          </span>
        )}
      </div>
    );
  }, [expandedPaths, togglePath]);

  // æ›´æ–°æˆªæ–­é€‰é¡¹
  const updateTruncationOption = useCallback((key: keyof TruncationOptions, value: any) => {
    setCustomTruncationOptions(prev => ({
      ...prev,
      [key]: value
    }));
  }, []);

  // é‡ç½®æˆªæ–­é€‰é¡¹
  const resetTruncationOptions = useCallback(() => {
    setCustomTruncationOptions({});
  }, []);

  return (
    <div className={`enhanced-json-viewer ${theme}`}>
      {/* å¤´éƒ¨ä¿¡æ¯å’Œæ§åˆ¶ */}
      <div className="json-viewer-header">
        <div className="json-title">
          <h3>{title}</h3>
          {largeContentInfo.isLarge && (
            <span className="large-content-warning">
              ğŸ“Š å¤§å‹å†…å®¹ ({(largeContentInfo.totalSize / 1024).toFixed(1)}KB)
            </span>
          )}
        </div>

        <div className="json-actions">
          <button onClick={expandAll} title="å±•å¼€å…¨éƒ¨">
            ğŸ“‚ å±•å¼€å…¨éƒ¨
          </button>
          <button onClick={collapseAll} title="æŠ˜å å…¨éƒ¨">
            ğŸ“ æŠ˜å å…¨éƒ¨
          </button>
          <button
            onClick={() => navigator.clipboard.writeText(JSON.stringify(data, null, 2))}
            title="å¤åˆ¶åŸå§‹æ•°æ®"
          >
            ğŸ“‹ å¤åˆ¶åŸå§‹
          </button>
          <button
            onClick={() => navigator.clipboard.writeText(JSON.stringify(truncatedData, null, 2))}
            title="å¤åˆ¶æˆªæ–­æ•°æ®"
          >
            ğŸ“‹ å¤åˆ¶æˆªæ–­
          </button>
        </div>
      </div>

      {/* æˆªæ–­æ§åˆ¶é¢æ¿ */}
      {showTruncationControls && enableTruncation && (
        <div className="truncation-controls">
          <div className="truncation-header">
            <h4>ğŸ”§ æˆªæ–­è®¾ç½®</h4>
            <button onClick={resetTruncationOptions} className="reset-btn">
              é‡ç½®
            </button>
          </div>

          <div className="truncation-options">
            <div className="option-group">
              <label>
                æœ€å¤§å­—ç¬¦æ•°:
                <input
                  type="number"
                  value={customTruncationOptions.maxLength || truncationSuggestions?.recommended.maxLength || 10000}
                  onChange={(e) => updateTruncationOption('maxLength', parseInt(e.target.value))}
                  min="100"
                  max="100000"
                />
              </label>
            </div>

            <div className="option-group">
              <label>
                æœ€å¤§è¡Œæ•°:
                <input
                  type="number"
                  value={customTruncationOptions.maxLines || truncationSuggestions?.recommended.maxLines || 50}
                  onChange={(e) => updateTruncationOption('maxLines', parseInt(e.target.value))}
                  min="10"
                  max="200"
                />
              </label>
            </div>

            <div className="option-group">
              <label>
                æ•°ç»„æœ€å¤§é¡¹æ•°:
                <input
                  type="number"
                  value={customTruncationOptions.maxArrayItems || truncationSuggestions?.recommended.maxArrayItems || 20}
                  onChange={(e) => updateTruncationOption('maxArrayItems', parseInt(e.target.value))}
                  min="5"
                  max="100"
                />
              </label>
            </div>

            <div className="option-group">
              <label>
                <input
                  type="checkbox"
                  checked={customTruncationOptions.showTruncationInfo !== false}
                  onChange={(e) => updateTruncationOption('showTruncationInfo', e.target.checked)}
                />
                æ˜¾ç¤ºæˆªæ–­ä¿¡æ¯
              </label>
            </div>
          </div>

          {/* æˆªæ–­å»ºè®® */}
          {truncationSuggestions && truncationSuggestions.detectedIssues.length > 0 && (
            <div className="truncation-suggestions">
              <h5>ğŸ’¡ æ™ºèƒ½å»ºè®®:</h5>
              <p>{truncationSuggestions.reason}</p>
              <ul>
                {truncationSuggestions.detectedIssues.map((issue, index) => (
                  <li key={index}>{issue}</li>
                ))}
              </ul>
            </div>
          )}

          {/* æˆªæ–­ä¿¡æ¯ */}
          {truncationInfo && truncationInfo.isTruncated && (
            <div className="truncation-info">
              <h5>ğŸ“Š æˆªæ–­ç»Ÿè®¡:</h5>
              <div className="info-grid">
                <div className="info-item">
                  <span>åŸå§‹å¤§å°:</span>
                  <span>{(truncationInfo.originalLength / 1024).toFixed(1)}KB</span>
                </div>
                <div className="info-item">
                  <span>æˆªæ–­å:</span>
                  <span>{(truncationInfo.truncatedLength / 1024).toFixed(1)}KB</span>
                </div>
                <div className="info-item">
                  <span>å‹ç¼©ç‡:</span>
                  <span>{((1 - truncationInfo.truncatedLength / truncationInfo.originalLength) * 100).toFixed(1)}%</span>
                </div>
                <div className="info-item">
                  <span>æˆªæ–­ç±»å‹:</span>
                  <span>{truncationInfo.truncationType}</span>
                </div>
              </div>

              {truncationInfo.truncatedPaths.length > 0 && (
                <div className="truncated-paths">
                  <h6>å·²æˆªæ–­è·¯å¾„:</h6>
                  <div className="path-list">
                    {truncationInfo.truncatedPaths.slice(0, 5).map((path, index) => (
                      <span key={index} className="path-tag">{path}</span>
                    ))}
                    {truncationInfo.truncatedPaths.length > 5 && (
                      <span className="path-more">+{truncationInfo.truncatedPaths.length - 5} more</span>
                    )}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      )}

      {/* JSONå†…å®¹ */}
      <div className="json-content">
        {renderJsonValue(truncatedData, 'root', 0)}
      </div>
    </div>
  );
};

export default EnhancedJsonViewer;