# Provider V2 Module

## Purpose
Provider V2 is transport-only: HTTP auth, retries, compatibility hooks, and snapshots. All tool governance and routing decisions live in Hub Pipeline.

## Entry Flow
```
routecodex-server → Hub Pipeline → Provider V2
                                  └─ core/   (HTTP + snapshots)
```

## Key Files
- `core/runtime/*-http-provider.ts`: Protocol-specific implementations (Chat/Responses/Anthropic/Gemini)
- `core/strategies/`: OAuth flows (device/code/hybrid)
- `core/utils/provider-error-reporter.ts`: Emit errors via `errorHandlingCenter`

## Configuration
Provider runtime generated by `bootstrapVirtualRouterConfig`. Host injects `ProviderRuntimeMetadata` at request time.

## Streaming Timeouts
Provider V2 may use upstream SSE; timeouts are **config-driven** via env (or provider overrides where noted).

### Provider → Upstream (SSE)
- `ROUTECODEX_PROVIDER_TIMEOUT_MS` / `RCC_PROVIDER_TIMEOUT_MS`: global provider request timeout (default `500000`).
- `ROUTECODEX_PROVIDER_STREAM_HEADERS_TIMEOUT_MS` / `RCC_PROVIDER_STREAM_HEADERS_TIMEOUT_MS`: wait for first response headers (default `min(300000, providerTimeout)`).
- `ROUTECODEX_PROVIDER_STREAM_IDLE_TIMEOUT_MS` / `RCC_PROVIDER_STREAM_IDLE_TIMEOUT_MS`: abort if upstream stream produces no bytes (default `min(300000, providerTimeout)`).

### Host → Client (SSE bridge)
These are enforced in the HTTP server SSE bridge (not in provider runtime), but often tuned together with upstream streaming:
- `ROUTECODEX_HTTP_SSE_IDLE_TIMEOUT_MS` / `RCC_HTTP_SSE_IDLE_TIMEOUT_MS`: client SSE idle timeout (default `300000`).
- `ROUTECODEX_HTTP_SSE_TIMEOUT_MS` / `RCC_HTTP_SSE_TIMEOUT_MS`: client SSE total timeout (default `500000`).

## Rate-limit cooldown knobs
These envs influence how the provider layer annotates retry/cooldown hints for VirtualRouter.

- `ROUTECODEX_RL_CAPACITY_COOLDOWN` / `RCC_RL_CAPACITY_COOLDOWN`: series cooldown used for short-lived "No capacity available" / `MODEL_CAPACITY_EXHAUSTED` 429s (default `30s`).

## Do / Don't
**Do**
- Handle HTTP, auth, retries, snapshots
- Emit provider errors via `emitProviderError` with dependencies
- Stay transport-only

**Don't**
- Implement tool logic or routing decisions
- Manually patch payload or config
- Bypass Hub Pipeline
