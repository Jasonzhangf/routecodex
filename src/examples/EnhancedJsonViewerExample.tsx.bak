import React, { useState } from 'react';
import { EnhancedJsonViewer } from '../components/EnhancedJsonViewer';
import { MessageTruncator } from '../utils/message-truncator';

// ç¤ºä¾‹æ•°æ® - æ¨¡æ‹Ÿå¤§å‹æµæ°´çº¿æ•°æ®
const createSampleData = () => {
  // å¤§å‹æ¶ˆæ¯å†…å®¹
  const largeMessage = "è¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„æ¶ˆæ¯å†…å®¹ï¼Œç”¨äºæµ‹è¯•æˆªæ–­åŠŸèƒ½ã€‚" +
    "åœ¨çœŸå®çš„AIåº”ç”¨åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°å¾ˆé•¿çš„å¯¹è¯å†å²ã€".repeat(20) +
    "æˆ–è€…å¤§é‡çš„å·¥å…·è°ƒç”¨ç»“æœã€‚è¿™äº›å†…å®¹å¦‚æœä¸è¿›è¡Œé€‚å½“å¤„ç†ï¼Œ".repeat(15) +
    "ä¼šä¸¥é‡å½±å“é¡µé¢æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚é€šè¿‡æ™ºèƒ½æˆªæ–­ï¼Œæˆ‘ä»¬å¯ä»¥".repeat(10) +
    "åœ¨ä¿æŒæ•°æ®ç»“æ„å®Œæ•´æ€§çš„åŒæ—¶ï¼Œåªæ˜¾ç¤ºå…³é”®ä¿¡æ¯ã€‚".repeat(8);

  // å¤§å‹æ•°ç»„
  const largeArray = Array.from({ length: 50 }, (_, i) => ({
    id: `item-${i}`,
    content: `æ•°ç»„é¡¹ ${i} çš„å†…å®¹`,
    metadata: {
      index: i,
      timestamp: Date.now() + i * 1000,
      details: `è¯¦ç»†ä¿¡æ¯ ${i}`.repeat(5)
    }
  }));

  // æ·±å±‚åµŒå¥—å¯¹è±¡
  const deepObject = {
    level1: {
      level2: {
        level3: {
          level4: {
            level5: {
              data: "æ·±å±‚åµŒå¥—æ•°æ®",
              array: largeArray.slice(0, 10),
              messages: Array.from({ length: 30 }, (_, i) => ({
                role: i % 2 === 0 ? 'user' : 'assistant',
                content: largeMessage.substring(0, 100) + ` [æ¶ˆæ¯ ${i}]`
              }))
            }
          }
        }
      }
    }
  };

  return {
    pipeline: {
      id: 'pipeline-123',
      type: 'llm-switch â†’ compatibility â†’ provider â†’ ai-service',
      status: 'running',
      startTime: Date.now(),
      nodes: [
        {
          id: 'llm-switch-1',
          name: 'OpenAI Passthrough',
          type: 'llm-switch',
          input: {
            model: 'gpt-4',
            messages: [
              {
                role: 'system',
                content: 'ä½ æ˜¯ä¸€ä¸ª helpful assistant'
              },
              {
                role: 'user',
                content: largeMessage
              },
              ...Array.from({ length: 25 }, (_, i) => ({
                role: i % 2 === 0 ? 'user' : 'assistant',
                content: `å¯¹è¯æ¶ˆæ¯ ${i}: ${largeMessage.substring(0, 200)}...`
              }))
            ],
            max_tokens: 4000,
            temperature: 0.7
          },
          output: {
            routing: {
              category: 'longcontext',
              confidence: 0.85,
              reasoning: 'é•¿æ–‡æœ¬å¤„ç†è¯·æ±‚ï¼Œéœ€è¦å¤§ä¸Šä¸‹æ–‡æ”¯æŒ'
            },
            metadata: {
              processingTime: 150,
              tokensEstimated: 2500
            }
          }
        },
        {
          id: 'compatibility-1',
          name: 'LM Studio Compatibility',
          type: 'compatibility',
          input: {
            originalRequest: {
              model: 'gpt-4',
              messages: largeArray.slice(0, 5).map((item, i) => ({
                role: i % 2 === 0 ? 'user' : 'assistant',
                content: item.content
              }))
            },
            transformedRequest: {
              model: 'qwen-turbo',
              messages: largeArray.slice(0, 5).map((item, i) => ({
                role: i % 2 === 0 ? 'user' : 'assistant',
                content: item.content
              }))
            }
          },
          output: {
            compatibility: {
              toolsConverted: 3,
              formatAdapted: true,
              providerReady: true
            }
          }
        },
        {
          id: 'provider-1',
          name: 'Qwen Provider',
          type: 'provider',
          input: {
            model: 'qwen-turbo',
            messages: largeArray.slice(0, 10).map((item, i) => ({
              role: i % 2 === 0 ? 'user' : 'assistant',
              content: item.content
            })),
            tools: [
              {
                type: 'function',
                function: {
                  name: 'get_weather',
                  description: 'è·å–å¤©æ°”ä¿¡æ¯',
                  parameters: {
                    type: 'object',
                    properties: {
                      location: {
                        type: 'string',
                        description: 'åŸå¸‚åç§°'
                      },
                      unit: {
                        type: 'string',
                        enum: ['celsius', 'fahrenheit']
                      }
                    },
                    required: ['location']
                  }
                }
              }
            ]
          },
          output: {
            response: {
              id: 'chat-123',
              object: 'chat.completion',
              created: Date.now(),
              model: 'qwen-turbo',
              choices: [
                {
                  index: 0,
                  message: {
                    role: 'assistant',
                    content: largeMessage.substring(0, 500) + '... [å“åº”å†…å®¹è¢«æˆªæ–­]'
                  },
                  finish_reason: 'stop'
                }
              ],
              usage: {
                prompt_tokens: 1500,
                completion_tokens: 800,
                total_tokens: 2300
              }
            },
            metadata: {
              provider: 'qwen',
              processingTime: 2800,
              success: true
            }
          }
        }
      ],
      performance: {
        totalTime: 3200,
        nodeTimes: [150, 250, 2800],
        memoryUsage: {
          used: 256 * 1024 * 1024,
          total: 512 * 1024 * 1024,
          percentage: 50
        }
      },
      deepData: deepObject
    }
  };
};

export const EnhancedJsonViewerExample: React.FC = () => {
  const [sampleData] = useState(() => createSampleData());
  const [activeTab, setActiveTab] = useState<'input' | 'output' | 'config' | 'performance'>('input');
  const [truncationEnabled, setTruncationEnabled] = useState(true);
  const [theme, setTheme] = useState<'light' | 'dark'>('light');

  // è·å–å½“å‰æ˜¾ç¤ºçš„æ•°æ®
  const getCurrentData = () => {
    switch (activeTab) {
      case 'input':
        return sampleData.pipeline.nodes[0].input;
      case 'output':
        return sampleData.pipeline.nodes[2].output;
      case 'config':
        return sampleData.pipeline;
      case 'performance':
        return sampleData.pipeline.performance;
      default:
        return sampleData;
    }
  };

  // å¤§å‹å†…å®¹æ£€æµ‹
  const contentAnalysis = MessageTruncator.detectLargeContent(getCurrentData());

  return (
    <div className={`example-container ${theme}`}>
      <style>
        {`
          .example-container {
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          }
          .example-container.dark {
            background: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
          }
          .example-header {
            margin-bottom: 20px;
          }
          .example-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
          }
          .example-description {
            color: #666;
            margin-bottom: 16px;
          }
          .dark .example-description {
            color: #aaa;
          }
          .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
          }
          .tab-buttons {
            display: flex;
            background: #f0f0f0;
            border-radius: 6px;
            padding: 4px;
          }
          .dark .tab-buttons {
            background: #333;
          }
          .tab-button {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
          }
          .tab-button.active {
            background: #007bff;
            color: white;
          }
          .dark .tab-button.active {
            background: #0056b3;
          }
          .control-button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
          }
          .control-button:hover {
            background: #f0f0f0;
          }
          .dark .control-button {
            background: #333;
            border-color: #555;
            color: #e0e0e0;
          }
          .dark .control-button:hover {
            background: #444;
          }
          .content-analysis {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 14px;
          }
          .dark .content-analysis {
            background: #2a2a2a;
            border-color: #444;
          }
          .analysis-title {
            font-weight: 600;
            margin-bottom: 8px;
          }
          .analysis-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
          }
          .stat-item {
            display: flex;
            justify-content: space-between;
          }
          .stat-label {
            color: #666;
          }
          .dark .stat-label {
            color: #aaa;
          }
          .stat-value {
            font-weight: 600;
          }
        `}
      </style>

      <div className="example-header">
        <h1 className="example-title">Enhanced JSON Viewer ç¤ºä¾‹</h1>
        <p className="example-description">
          æ¼”ç¤ºæ™ºèƒ½æˆªæ–­å’Œå¯æŠ˜å JSONæŸ¥çœ‹å™¨çš„åŠŸèƒ½ï¼Œç‰¹åˆ«é€‚ç”¨äºå¤§å‹æµæ°´çº¿æ•°æ®çš„å¯è§†åŒ–å±•ç¤ºã€‚
        </p>
      </div>

      <div className="controls">
        <div className="tab-buttons">
          {['input', 'output', 'config', 'performance'].map(tab => (
            <button
              key={tab}
              className={`tab-button ${activeTab === tab ? 'active' : ''}`}
              onClick={() => setActiveTab(tab as any)}
            >
              {tab === 'input' && 'è¾“å…¥æ•°æ®'}
              {tab === 'output' && 'è¾“å‡ºæ•°æ®'}
              {tab === 'config' && 'é…ç½®ä¿¡æ¯'}
              {tab === 'performance' && 'æ€§èƒ½æ•°æ®'}
            </button>
          ))}
        </div>

        <button
          className="control-button"
          onClick={() => setTruncationEnabled(!truncationEnabled)}
        >
          {truncationEnabled ? 'ç¦ç”¨æˆªæ–­' : 'å¯ç”¨æˆªæ–­'}
        </button>

        <button
          className="control-button"
          onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')}
        >
          {theme === 'light' ? 'æš—è‰²ä¸»é¢˜' : 'äº®è‰²ä¸»é¢˜'}
        </button>

        <button
          className="control-button"
          onClick={() => {
            const data = getCurrentData();
            navigator.clipboard.writeText(JSON.stringify(data, null, 2));
          }}
        >
          å¤åˆ¶æ•°æ®
        </button>
      </div>

      {/* å†…å®¹åˆ†æ */}
      {contentAnalysis.isLarge && (
        <div className="content-analysis">
          <div className="analysis-title">ğŸ“Š å†…å®¹åˆ†æ</div>
          <div className="analysis-stats">
            <div className="stat-item">
              <span className="stat-label">æ€»å¤§å°:</span>
              <span className="stat-value">{(contentAnalysis.totalSize / 1024).toFixed(1)}KB</span>
            </div>
            <div className="stat-item">
              <span className="stat-label">å¤§å‹å­—æ®µ:</span>
              <span className="stat-value">{contentAnalysis.largeFields.length}</span>
            </div>
            <div className="stat-item">
              <span className="stat-label">æˆªæ–­çŠ¶æ€:</span>
              <span className="stat-value">{truncationEnabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}</span>
            </div>
          </div>
          {contentAnalysis.largeFields.length > 0 && (
            <div style={{ marginTop: '8px' }}>
              <div style={{ fontSize: '12px', color: '#666' }}>
                æ£€æµ‹åˆ°çš„å¤§å‹å­—æ®µ: {contentAnalysis.largeFields.slice(0, 3).join(', ')}
                {contentAnalysis.largeFields.length > 3 && '...'}
              </div>
            </div>
          )}
        </div>
      )}

      {/* JSON æŸ¥çœ‹å™¨ */}
      <EnhancedJsonViewer
        data={getCurrentData()}
        title={`${activeTab === 'input' && 'è¾“å…¥æ•°æ®' || activeTab === 'output' && 'è¾“å‡ºæ•°æ®' || activeTab === 'config' && 'é…ç½®ä¿¡æ¯' || activeTab === 'performance' && 'æ€§èƒ½æ•°æ®'}`}
        initialExpanded={false}
        enableTruncation={truncationEnabled}
        showTruncationControls={true}
        theme={theme}
        onTruncationChange={(result) => {
          console.log('æˆªæ–­ç»“æœ:', result);
        }}
      />
    </div>
  );
};

export default EnhancedJsonViewerExample;