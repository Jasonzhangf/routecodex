<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>RouteCodex Daemon & Token Manager – Admin UI (Design Mock)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #0b1020;
        --bg-elevated: #151a2a;
        --bg-panel: #101626;
        --border-subtle: #262c3d;
        --accent: #4ea1ff;
        --accent-soft: rgba(78, 161, 255, 0.16);
        --accent-warn: #ffb547;
        --accent-err: #ff5f5f;
        --accent-ok: #4cd964;
        --text-main: #f5f7ff;
        --text-muted: #8b91a5;
        --text-soft: #5b6175;
        --pill-bg: #1b2235;
        --pill-border: #303750;
        --radius-lg: 10px;
        --radius-md: 6px;
        --radius-sm: 4px;
        --shadow-soft: 0 12px 30px rgba(0, 0, 0, 0.4);
        --shadow-pip: 0 0 0 1px rgba(255, 255, 255, 0.03);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #171f3a 0, #050814 50%, #02030a 100%);
        color: var(--text-main);
      }

      .chrome {
        max-width: 1180px;
        margin: 24px auto 40px;
        padding: 18px 22px 22px;
        border-radius: 18px;
        background: radial-gradient(circle at top left, #19213a, #060815 60%);
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 14px;
      }

      .title-block {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .title-mark {
        width: 28px;
        height: 28px;
        border-radius: 9px;
        background: radial-gradient(circle at 20% 0, #52a9ff, #2553ff 30%, #151c38 70%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        color: #e8f3ff;
        box-shadow: 0 0 0 1px rgba(193, 221, 255, 0.35);
      }

      .title-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .title-text h1 {
        margin: 0;
        font-size: 17px;
        font-weight: 600;
      }

      .title-text span {
        font-size: 11px;
        color: var(--text-soft);
      }

      .top-meta {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 9px;
        border-radius: 999px;
        border: 1px solid var(--pill-border);
        background: var(--pill-bg);
        font-size: 11px;
        color: var(--text-muted);
      }

      .pill-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: var(--accent-ok);
        box-shadow: 0 0 8px rgba(76, 217, 100, 0.7);
      }

      .pill-dot.warn {
        background: var(--accent-warn);
        box-shadow: 0 0 8px rgba(255, 181, 71, 0.7);
      }

      .pill-dot.err {
        background: var(--accent-err);
        box-shadow: 0 0 8px rgba(255, 95, 95, 0.7);
      }

      .pill strong {
        font-weight: 500;
        color: var(--text-main);
      }

      .tabs {
        display: flex;
        gap: 4px;
        margin: 10px 0 14px;
        border-bottom: 1px solid var(--border-subtle);
      }

      .tab {
        border: none;
        background: transparent;
        padding: 7px 12px 8px;
        font-size: 12px;
        color: var(--text-soft);
        border-radius: 999px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: background 0.15s, color 0.15s;
      }

      .tab.active {
        background: var(--accent-soft);
        color: var(--accent);
      }

      .tab-badge {
        min-width: 18px;
        padding: 0 5px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        font-size: 10px;
        text-align: center;
        color: var(--text-muted);
      }

      main {
        margin-top: 8px;
      }

      .tab-panel {
        display: none;
      }

      .tab-panel.active {
        display: block;
      }

      .panel-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.2fr);
        gap: 14px;
      }

      .panel {
        background: var(--bg-panel);
        border-radius: var(--radius-lg);
        padding: 12px 14px;
        box-shadow: var(--shadow-pip);
        border: 1px solid rgba(255, 255, 255, 0.03);
      }

      .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .panel-title {
        font-size: 13px;
        font-weight: 500;
      }

      .panel-sub {
        font-size: 11px;
        color: var(--text-soft);
      }

      .kv-row {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        font-size: 11px;
        padding: 4px 0;
        color: var(--text-muted);
      }

      .kv-row strong {
        color: var(--text-main);
      }

      .kv-row span.value-soft {
        color: var(--text-soft);
      }

      .stat-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
        margin-top: 4px;
      }

      .stat-card {
        background: var(--bg-elevated);
        border-radius: var(--radius-md);
        padding: 8px 9px;
        border: 1px solid rgba(255, 255, 255, 0.04);
      }

      .stat-label {
        font-size: 11px;
        color: var(--text-soft);
      }

      .stat-value {
        font-size: 15px;
        font-weight: 500;
        margin-top: 2px;
        color: var(--text-main);
      }

      .stat-foot {
        font-size: 10px;
        margin-top: 1px;
        color: var(--text-muted);
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        border-radius: 999px;
        font-size: 10px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        color: var(--text-soft);
      }

      .badge.ok {
        border-color: rgba(102, 219, 148, 0.35);
        color: #a4f4c2;
      }

      .badge.warn {
        border-color: rgba(255, 181, 71, 0.45);
        color: #ffd9a0;
      }

      .badge.err {
        border-color: rgba(255, 120, 120, 0.6);
        color: #ffc0c0;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
        margin-top: 4px;
      }

      .table th,
      .table td {
        padding: 4px 6px;
        text-align: left;
        border-bottom: 1px solid var(--border-subtle);
      }

      .table th {
        font-weight: 500;
        color: var(--text-soft);
        font-size: 10px;
      }

      .table tr:last-child td {
        border-bottom: none;
      }

      .table tr:hover td {
        background: rgba(255, 255, 255, 0.02);
      }

      .tag {
        display: inline-flex;
        padding: 1px 6px;
        border-radius: 999px;
        font-size: 10px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--text-muted);
      }

      .tag.antigravity {
        border-color: rgba(78, 161, 255, 0.6);
        color: #c6e1ff;
      }

      .tag.openai {
        border-color: rgba(90, 199, 157, 0.6);
        color: #bff0d8;
      }

      .tag.anthropic {
        border-color: rgba(255, 151, 112, 0.6);
        color: #ffd3bf;
      }

      .btn-ghost {
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: transparent;
        color: var(--text-muted);
        font-size: 11px;
        padding: 3px 8px;
        cursor: pointer;
      }

      .btn-ghost:hover {
        background: rgba(255, 255, 255, 0.06);
      }

      .btn-accent {
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, #4ea1ff, #577bff);
        color: #020310;
        font-size: 11px;
        padding: 4px 10px;
        cursor: pointer;
      }

      .btn-accent:hover {
        filter: brightness(1.05);
      }

      .pill-small {
        font-size: 10px;
        padding: 1px 6px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--text-soft);
      }

      .note {
        margin-top: 8px;
        padding: 6px 8px;
        border-radius: var(--radius-md);
        background: rgba(255, 255, 255, 0.02);
        font-size: 10px;
        color: var(--text-soft);
      }

      .note code {
        font-size: 10px;
        padding: 0 3px;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.04);
      }

      .subtabs {
        display: inline-flex;
        gap: 4px;
        margin-bottom: 8px;
        border-radius: 999px;
        padding: 2px;
        background: rgba(255, 255, 255, 0.02);
      }

      .subtab {
        border: none;
        background: transparent;
        padding: 3px 9px;
        font-size: 11px;
        color: var(--text-soft);
        border-radius: 999px;
        cursor: pointer;
      }

      .subtab.active {
        background: rgba(255, 255, 255, 0.05);
        color: var(--accent);
      }

      .subtab-panel {
        display: none;
      }

      .subtab-panel.active {
        display: block;
      }

      @media (max-width: 900px) {
        .chrome {
          margin: 12px;
          padding: 14px;
        }
        .panel-grid {
          grid-template-columns: minmax(0, 1fr);
        }
        header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
        .top-meta {
          flex-wrap: wrap;
        }
      }
    </style>
  </head>
  <body>
    <div class="chrome">
      <header>
        <div class="title-block">
          <div class="title-mark">TM</div>
          <div class="title-text">
            <h1>Token Daemon & Health Console</h1>
            <span>RouteCodex – Daemon module · API-driven UI (design mock)</span>
          </div>
        </div>
        <div class="top-meta">
          <div class="pill">
            <div class="pill-dot"></div>
            <span>Daemon</span>
            <strong>online</strong>
          </div>
          <div class="pill">
            <span>llms</span>
            <strong>0.6.568</strong>
          </div>
          <div class="pill">
            <span>RouteCodex</span>
            <strong>0.89.872</strong>
          </div>
        </div>
      </header>

      <nav class="tabs">
        <button class="tab active" data-tab="overview">
          Overview
          <span class="tab-badge">3</span>
        </button>
        <button class="tab" data-tab="tokens">
          Token &amp; Quota
          <span class="tab-badge">2</span>
        </button>
        <button class="tab" data-tab="credentials">
          Credentials
          <span class="tab-badge">5</span>
        </button>
        <button class="tab" data-tab="providers">
          Providers
          <span class="tab-badge">4</span>
        </button>
        <button class="tab" data-tab="settings">
          Settings
        </button>
      </nav>

      <main>
        <!-- Overview: daemon + overall health -->
        <section id="tab-overview" class="tab-panel active">
          <div class="panel-grid">
            <section class="panel">
              <div class="panel-header">
                <div>
                  <div class="panel-title">Daemon Status</div>
                  <div class="panel-sub">
                    Single leader – token manager integrated into RouteCodex
                  </div>
                </div>
                <span class="badge ok">
                  <span class="pill-dot"></span>
                  healthy
                </span>
              </div>
              <div class="kv-row">
                <span>Leader process</span>
                <span class="value-soft" id="daemon-leader">server:127.0.0.1:5809</span>
              </div>
              <div class="kv-row">
                <span>Uptime</span>
                <strong id="daemon-uptime">--:--:--</strong>
              </div>
              <div class="kv-row">
                <span>Managed tokens</span>
                <strong id="daemon-token-count">0</strong>
              </div>
              <div class="kv-row">
                <span>Last error</span>
                <span class="value-soft">none in last 15 min</span>
              </div>
              <div class="note">
                Backend API (design only): <code>GET /daemon/status</code>,
                <code>GET /daemon/metrics</code>
              </div>
            </section>

            <section class="panel">
              <div class="panel-header">
                <div>
                  <div class="panel-title">Health &amp; Quota Summary</div>
                  <div class="panel-sub">
                    Aggregated view across Antigravity / OpenAI / Anthropic /
                    Gemini
                  </div>
                </div>
                <button class="btn-ghost" type="button">Refresh snapshot</button>
              </div>
              <div class="stat-grid">
                <div class="stat-card">
                  <div class="stat-label">Active providers</div>
                  <div class="stat-value" id="stat-active-providers">0</div>
                  <div class="stat-foot">5 healthy · 2 cooling down</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">429 bursts (last 15 min)</div>
                  <div class="stat-value" style="color: var(--accent-warn)">
                    <span id="stat-429-bursts">0</span>
                  </div>
                  <div class="stat-foot">Antigravity · gemini-pro series</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Quota window</div>
                  <div class="stat-value">rolling</div>
                  <div class="stat-foot">Server-side cooldown active</div>
                </div>
              </div>
              <div class="note">
                Backend API（设计）：<code>GET /quota/summary</code> 返回每个
                runtime 的 token 用量和 429 冷却窗口，用于填充此面板。
              </div>
            </section>
          </div>
        </section>

        <!-- Token & Quota tab -->
        <section id="tab-tokens" class="tab-panel">
          <div class="panel-grid">
            <section class="panel">
              <div class="panel-header">
                <div>
                  <div class="panel-title">Token Usage &amp; Quota</div>
                  <div class="panel-sub">
                    Per-runtime usage summary (windowed prompt/completion tokens)
                  </div>
                </div>
                <button class="btn-ghost" type="button">Export CSV</button>
              </div>
              <table class="table">
                <thead>
                  <tr>
                    <th>Runtime</th>
                    <th>Window</th>
                    <th>Prompt</th>
                    <th>Completion</th>
                    <th>Quota</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <span class="tag antigravity">antigravity.jasonqueque</span>
                    </td>
                    <td>15 min</td>
                    <td>18.2k</td>
                    <td>4.1k</td>
                    <td>~50k</td>
                    <td><span class="badge ok">within limits</span></td>
                  </tr>
                  <tr>
                    <td>
                      <span class="tag antigravity"
                        >antigravity.jasonqueque.gemini-3-pro</span
                      >
                    </td>
                    <td>15 min</td>
                    <td>7.5k</td>
                    <td>2.9k</td>
                    <td>~10k</td>
                    <td><span class="badge warn">near 429</span></td>
                  </tr>
                  <tr>
                    <td>
                      <span class="tag openai">openai.default</span>
                    </td>
                    <td>1 hour</td>
                    <td>32.1k</td>
                    <td>8.7k</td>
                    <td>soft</td>
                    <td><span class="badge ok">ok</span></td>
                  </tr>
                </tbody>
              </table>
              <div class="note">
                这里的行数据应由 <code>GET /quota/runtime</code> 提供（返回每个
                runtime 的滑动窗口 token 使用量和 quota 状态），UI 不做配额判定。
              </div>
            </section>

            <section class="panel">
              <div class="panel-header">
                <div>
                  <div class="panel-title">429 Cooldowns</div>
                  <div class="panel-sub">
                    Virtual router series cooldown view (read-only)
                  </div>
                </div>
                <button class="btn-ghost" type="button">View route log</button>
              </div>
              <table class="table">
                <thead>
                  <tr>
                    <th>Series</th>
                    <th>Provider</th>
                    <th>Cooldown</th>
                    <th>Remaining</th>
                    <th>Last 429</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>gemini-pro</td>
                    <td>
                      <span class="tag antigravity"
                        >antigravity.jasonqueque.gemini-3-pro-low</span
                      >
                    </td>
                    <td>300s</td>
                    <td>180s</td>
                    <td>10:45:02</td>
                  </tr>
                  <tr>
                    <td>claude</td>
                    <td>
                      <span class="tag antigravity"
                        >antigravity.jasonqueque.claude-sonnet-4-5</span
                      >
                    </td>
                    <td>300s</td>
                    <td>cooling off</td>
                    <td>09:52:45</td>
                  </tr>
                </tbody>
              </table>
              <div class="note">
                后端可复用现有虚拟路由的
                <code>series cooldown</code> 数据源，通过
                <code>GET /quota/cooldowns</code> 暴露为只读 API。
              </div>
            </section>
          </div>
        </section>

        <!-- Credentials tab -->
        <section id="tab-credentials" class="tab-panel">
          <section class="panel">
            <div class="panel-header">
              <div>
                <div class="panel-title">Credentials Directory</div>
                <div class="panel-sub">
                  Files under <code>~/.routecodex/auth</code> managed by daemon
                </div>
              </div>
              <div style="display: flex; gap: 6px">
                <button class="btn-ghost" type="button">Rescan</button>
                <button class="btn-accent" type="button">Import...</button>
              </div>
            </div>
            <div class="kv-row">
              <span>Base directory</span>
              <span class="value-soft">/Users/&lt;user&gt;/.routecodex/auth</span>
            </div>
            <div class="kv-row">
              <span>Total credentials</span>
              <strong id="credentials-total">0</strong>
            </div>
            <div class="kv-row">
              <span>Antigravity</span>
              <span class="value-soft" id="credentials-antigravity">0 active</span>
            </div>
            <div class="kv-row">
              <span>Other providers</span>
              <span class="value-soft" id="credentials-others">-</span>
            </div>
          </section>

          <section class="panel" style="margin-top: 10px">
            <div class="panel-header">
              <div>
                <div class="panel-title">Credential List</div>
                <div class="panel-sub">
                  Non-sensitive view; secrets never rendered in the browser
                </div>
              </div>
              <button class="btn-ghost" type="button">Export selected</button>
            </div>
            <table class="table">
              <thead>
                <tr>
                  <th>Provider</th>
                  <th>Runtime</th>
                  <th>Type</th>
                  <th>Project / Tenant</th>
                  <th>Status</th>
                  <th>Last Verified</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="credentials-table-body">
                <!-- Rows will be populated via /daemon/credentials -->
              </tbody>
            </table>
            <div class="note">
              API 设计示例：<code>GET /daemon/credentials</code> 列表，
              <code>POST /daemon/credentials/:id/verify</code> 校验，
              <code>POST /daemon/credentials/:id/refresh</code> 刷新。
            </div>
          </section>
        </section>

        <!-- Providers tab -->
        <section id="tab-providers" class="tab-panel">
          <div class="subtabs">
            <button class="subtab active" data-subtab="providers-runtime">
              Runtime health
            </button>
            <button class="subtab" data-subtab="providers-configv2">
              Config V2
            </button>
          </div>

          <section id="providers-runtime" class="subtab-panel active">
            <section class="panel">
              <div class="panel-header">
                <div>
                  <div class="panel-title">Provider Runtimes</div>
                  <div class="panel-sub">
                    Virtual router runtime view, with bound credentials &amp; health
                  </div>
                </div>
                <button class="btn-ghost" type="button" id="providers-reload-btn">
                  Reload
                </button>
              </div>
              <table class="table">
                <thead>
                  <tr>
                    <th>Runtime</th>
                    <th>Provider</th>
                    <th>Protocol</th>
                    <th>Series</th>
                    <th>Enabled</th>
                  </tr>
                </thead>
                <tbody id="providers-runtime-body">
                  <!-- Rows will be populated via /providers/runtimes -->
                </tbody>
              </table>
              <div class="note">
                API：<code>GET /providers/runtimes</code> 返回 runtime 级视图；UI 只读展示，不参与路由决策。
              </div>
            </section>
          </section>

          <section id="providers-configv2" class="subtab-panel">
            <section class="panel">
              <div class="panel-header">
                <div>
                  <div class="panel-title">Providers (Config V2)</div>
                  <div class="panel-sub">
                    Read-only view of declarative provider definitions from Config V2
                  </div>
                </div>
                <button class="btn-ghost" type="button" id="providers-configv2-reload-btn">
                  Refresh
                </button>
              </div>
              <ul id="providers-configv2-list" class="note"></ul>
              <div class="note" id="providers-configv2-note"></div>
            </section>
          </section>
        </section>

        <!-- Settings tab -->
        <section id="tab-settings" class="tab-panel">
          <section class="panel">
            <div class="panel-header">
              <div>
                <div class="panel-title">Daemon Module Settings</div>
                <div class="panel-sub">
                  Read-only view; configuration remains file-driven
                </div>
              </div>
            </div>
            <div class="kv-row">
              <span>Credentials dir</span>
              <span class="value-soft">/Users/&lt;user&gt;/.routecodex/auth</span>
            </div>
            <div class="kv-row">
              <span>API base URL</span>
              <span class="value-soft">http://127.0.0.1:5555</span>
            </div>
            <div class="kv-row">
              <span>Daemon API prefix</span>
              <span class="value-soft">/daemon</span>
            </div>
            <div class="kv-row">
              <span>Quota API prefix</span>
              <span class="value-soft">/quota</span>
            </div>
            <div class="note">
              这些设置应来源于 RouteCodex 的配置文件（例如
              <code>routecodex-config-loader</code> 生成的结果），UI 仅展示，不写回配置。
            </div>
          </section>
        </section>
      </main>
    </div>

    <script>
      // --- Basic tab switching ---
      const tabs = Array.from(document.querySelectorAll(".tab"));
      const panels = Array.from(document.querySelectorAll(".tab-panel"));

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          const id = tab.getAttribute("data-tab");
          tabs.forEach((t) => t.classList.toggle("active", t === tab));
          panels.forEach((p) =>
            p.classList.toggle("active", p.id === "tab-" + id)
          );
        });
      });

      // Providers subtabs
      const subtabs = Array.from(document.querySelectorAll(".subtab"));
      const subpanels = Array.from(
        document.querySelectorAll(".subtab-panel")
      );
      subtabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          const id = tab.getAttribute("data-subtab");
          subtabs.forEach((t) => t.classList.toggle("active", t === tab));
          subpanels.forEach((p) =>
            p.classList.toggle("active", p.id === id)
          );
        });
      });

      // --- Lightweight API wiring ---
      (function () {
        const origin = window.location.origin;
        const apiBase =
          origin && origin.startsWith("http")
            ? origin
            : "http://127.0.0.1:5555";

        async function fetchJson(path) {
          try {
            const res = await fetch(apiBase + path, {
              method: "GET",
              credentials: "omit",
            });
            if (!res.ok) {
              throw new Error(`HTTP ${res.status}`);
            }
            return await res.json();
          } catch (err) {
            console.warn("[daemon-admin-ui] fetch failed", path, err);
            return null;
          }
        }

        function formatDuration(seconds) {
          if (!seconds || !Number.isFinite(seconds) || seconds <= 0) {
            return "--:--:--";
          }
          const h = Math.floor(seconds / 3600);
          const m = Math.floor((seconds % 3600) / 60);
          const s = Math.floor(seconds % 60);
          const pad = (n) => String(n).padStart(2, "0");
          return `${pad(h)}:${pad(m)}:${pad(s)}`;
        }

        function formatExpires(expiresAt) {
          if (!expiresAt || !Number.isFinite(expiresAt)) {
            return "-";
          }
          try {
            return new Date(expiresAt).toISOString();
          } catch {
            return "-";
          }
        }

        async function loadDaemonStatus() {
          const data = await fetchJson("/daemon/status");
          if (!data) return;

          const leaderEl = document.getElementById("daemon-leader");
          const uptimeEl = document.getElementById("daemon-uptime");
          const tokenCountEl = document.getElementById("daemon-token-count");

          if (leaderEl && typeof data.serverId === "string") {
            leaderEl.textContent = data.serverId;
          }
          if (uptimeEl && typeof data.uptimeSec === "number") {
            uptimeEl.textContent = formatDuration(data.uptimeSec);
          }
          if (tokenCountEl && data.manager && Array.isArray(data.manager.modules)) {
            // 这里没有直接的 token 数量信息，保持占位符 0，后续可由更精确的 API 覆盖。
            tokenCountEl.textContent = String(tokenCountEl.textContent || "0");
          }
        }

        async function loadCredentials() {
          const items = await fetchJson("/daemon/credentials");
          if (!Array.isArray(items)) return;

          const totalEl = document.getElementById("credentials-total");
          const agEl = document.getElementById("credentials-antigravity");
          const othersEl = document.getElementById("credentials-others");
          const tbody = document.getElementById("credentials-table-body");

          const total = items.length;
          const agCount = items.filter((c) => c.provider === "antigravity")
            .length;
          const otherProviders = new Map();
          for (const c of items) {
            if (c.provider === "antigravity") continue;
            otherProviders.set(c.provider, (otherProviders.get(c.provider) || 0) + 1);
          }

          if (totalEl) totalEl.textContent = String(total);
          if (agEl) agEl.textContent = `${agCount} active`;
          if (othersEl) {
            if (otherProviders.size === 0) {
              othersEl.textContent = "-";
            } else {
              const parts = [];
              for (const [name, count] of otherProviders.entries()) {
                parts.push(`${name}(${count})`);
              }
              othersEl.textContent = parts.join(" · ");
            }
          }

          if (tbody) {
            tbody.innerHTML = "";
            for (const c of items) {
              const tr = document.createElement("tr");
              tr.dataset.tokenFile = c.tokenFile || "";
              tr.dataset.provider = c.provider || "";
              tr.dataset.credentialId = c.id || "";

              const providerTag = document.createElement("span");
              providerTag.className = "tag " + (c.provider || "").toLowerCase();
              providerTag.textContent = c.provider;

              const statusBadge = document.createElement("span");
              statusBadge.className =
                "badge " +
                (c.status === "valid"
                  ? "ok"
                  : c.status === "expiring"
                  ? "warn"
                  : "err");
              statusBadge.textContent = c.status || "unknown";

              const expiresAt = formatExpires(c.expiresAt);

              tr.innerHTML = `
                <td></td>
                <td>${c.alias || "-"}</td>
                <td>${c.kind === "oauth" ? "OAuth2" : "API Key"}</td>
                <td>${c.projectId || "-"}</td>
                <td></td>
                <td>${expiresAt}</td>
                <td><button class="btn-ghost" type="button">Verify</button></td>
              `;
              tr.children[0].appendChild(providerTag);
              tr.children[4].appendChild(statusBadge);
              tbody.appendChild(tr);
            }
          }
        }

        async function loadQuotaSummary() {
          const data = await fetchJson("/quota/summary");
          const records = Array.isArray(data?.records) ? data.records : [];
          const activeProvidersEl = document.getElementById(
            "stat-active-providers"
          );
          const burstsEl = document.getElementById("stat-429-bursts");
          if (activeProvidersEl) {
            activeProvidersEl.textContent = String(records.length);
          }
          if (burstsEl) {
            burstsEl.textContent = "0";
          }
        }

        async function loadProvidersRuntime() {
          const rows = await fetchJson("/providers/runtimes");
          if (!Array.isArray(rows)) return;
          const tbody = document.getElementById("providers-runtime-body");
          if (!tbody) return;
          tbody.innerHTML = "";
          for (const row of rows) {
            const tr = document.createElement("tr");
            const family = (row.family || row.providerKey || "").toLowerCase();
            const tag = document.createElement("span");
            tag.className = "tag " + family;
            tag.textContent = row.family || "provider";
            tr.innerHTML = `
              <td>${row.runtimeKey || "-"}</td>
              <td></td>
              <td>${row.protocol || "-"}</td>
              <td>${row.series || "-"}</td>
              <td>${row.enabled ? "yes" : "no"}</td>
            `;
            tr.children[1].appendChild(tag);
            tbody.appendChild(tr);
          }
        }

        async function loadProvidersConfigV2(selectedTokenFile) {
          const data = await fetchJson("/config/providers/v2");
          const note = document.getElementById("providers-configv2-note");
          const list = document.getElementById("providers-configv2-list");
          if (!note || !list) return;
          list.innerHTML = "";
          if (!Array.isArray(data) || data.length === 0) {
            note.textContent =
              "Config V2 provider view is not wired yet or returned an empty list.";
            return;
          }

          let items = data;
          if (selectedTokenFile) {
            items = data.filter(
              (p) => p.credentialsRef && p.credentialsRef === selectedTokenFile
            );
          }

          note.textContent = selectedTokenFile
            ? `Config V2 providers using credential: ${selectedTokenFile} (count=${items.length})`
            : `Config V2 providers: ${data.length} (use credential click to filter by tokenFile).`;

          for (const p of items) {
            const li = document.createElement("li");
            li.textContent = `${p.id} · ${p.family || "-"} · ${p.protocol || "-"} · ${p.credentialsRef || "-"}`;
            list.appendChild(li);
          }
        }

        document
          .getElementById("providers-reload-btn")
          ?.addEventListener("click", () => {
            void loadProvidersRuntime();
          });

        document
          .getElementById("providers-configv2-reload-btn")
          ?.addEventListener("click", async () => {
            await loadProvidersConfigV2(null);
          });

        // 点击 Credentials 行时，跳转到 Providers(Config V2) 并按 tokenFile 过滤。
        const credentialsBody = document.getElementById(
          "credentials-table-body"
        );
        if (credentialsBody) {
          credentialsBody.addEventListener("click", async (ev) => {
            const tr = (ev.target as HTMLElement).closest("tr");
            if (!tr || !tr.dataset.tokenFile) return;

            // 高亮选中行
            Array.from(credentialsBody.querySelectorAll("tr")).forEach((row) =>
              row.classList.toggle("active", row === tr)
            );

            // 切换到 Providers -> Config V2 视图
            const providersTab = document.querySelector(
              '.tab[data-tab="providers"]'
            ) as HTMLButtonElement | null;
            if (providersTab) {
              providersTab.click();
            }
            const configV2Subtab = document.querySelector(
              '.subtab[data-subtab="providers-configv2"]'
            ) as HTMLButtonElement | null;
            if (configV2Subtab) {
              configV2Subtab.click();
            }

            await loadProvidersConfigV2(tr.dataset.tokenFile);
          });
        }

        // Initial load – best-effort,失败则静默退回到静态 mock。
        void loadDaemonStatus();
        void loadCredentials();
        void loadQuotaSummary();
        void loadProvidersRuntime();
      })();
    </script>
  </body>
</html>
