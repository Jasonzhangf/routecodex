# RouteCodex 系统架构文档

## 概述

RouteCodex 是一个多 Provider OpenAI 代理服务器，支持动态路由、负载均衡和兼容性处理。系统采用模块化设计，支持主题订阅、错误处理、调试中心等高级功能。

## 系统架构

### 核心组件

```
┌─────────────────────────────────────────────────────────────────┐
│                        RouteCodex 架构                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   HTTP Server   │  │   Config Mgr    │  │   Provider Mgr  │  │
│  │                 │  │                 │  │                 │  │
│  │  • 请求处理      │  │  • 配置管理      │  │  • Provider管理  │  │
│  │  • 路由分发      │  │  • 验证器        │  │  • 负载均衡      │  │
│  │  • 响应格式化    │  │  • 热重载        │  │  • 故障转移      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│           │                     │                     │         │
│           └─────────────────────┼─────────────────────┘         │
│                                 │                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Core Logic    │  │   MessageCenter │  │   DebugCenter   │  │
│  │                 │  │                 │  │                 │  │
│  │  • 请求转发      │  │  • 主题订阅      │  │  • 调试记录      │  │
│  │  • 响应处理      │  │  • 消息路由      │  │  • 性能监控      │  │
│  │  • 错误处理      │  │  • 模块通信      │  │  • 会话管理      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│           │                     │                     │         │
│           └─────────────────────┼─────────────────────┘         │
│                                 │                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │    Utilities    │  │   ErrorHandling  │  │     Patches     │  │
│  │                 │  │                 │  │                 │  │
│  │  • 日志工具      │  │  • 错误处理      │  │  • 兼容性补丁    │  │
│  │  • 负载均衡      │  │  • 重试机制      │  │  • 响应转换      │  │
│  │  • 故障转移      │  │  • 异常恢复      │  │  • 格式适配      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 主题订阅系统

#### MessageCenter 架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        MessageCenter                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Module Mgr    │  │TopicSubscription │  │MessageProcessor │  │
│  │                 │  │      Manager     │  │                 │  │
│  │  • 模块注册      │  │  • 主题订阅      │  │  • 消息验证      │  │
│  │  • 生命周期      │  │  • 通配符支持    │  │  • 消息处理      │  │
│  │  • 状态管理      │  │  • 订阅管理      │  │  • 路由分发      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│           │                     │                     │         │
│           └─────────────────────┼─────────────────────┘         │
│                                 │                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │Request Mgr     │  │Statistics Mgr   │  │ Broadcast Mgr   │  │
│  │                 │  │                 │  │                 │  │
│  │  • 请求管理      │  │  • 性能统计      │  │  • 消息广播      │  │
│  │  • 响应处理      │  │  • 监控指标      │  │  • 多播分发      │  │
│  │  • 超时控制      │  │  • 报告生成      │  │  • 订阅通知      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 主题订阅特性

1. **主题订阅**
   - 支持模块订阅特定主题
   - 动态订阅/取消订阅
   - 订阅状态管理

2. **通配符支持**
   - 支持通配符订阅所有主题
   - 灵活的消息路由
   - 订阅者过滤

3. **消息路由**
   - 基于主题的消息分发
   - 多播消息传递
   - 订阅者隔离

4. **统计监控**
   - 订阅统计信息
   - 消息传递统计
   - 性能指标收集

### 调试中心集成

#### DebugCenter 主题订阅集成

```
┌─────────────────────────────────────────────────────────────────┐
│                     DebugCenter                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Event Bus     │  │   Session Mgr   │  │   Topic Sub     │  │
│  │                 │  │                 │  │                 │  │
│  │  • 事件总线      │  │  • 会话管理      │  │  • 主题订阅      │  │
│  │  • 事件处理      │  │  • 状态跟踪      │  │  • 消息发布      │  │
│  │  • 订阅管理      │  │  • 生命周期      │  │  • 跨模块通信    │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│           │                     │                     │         │
│           └─────────────────────┼─────────────────────┘         │
│                                 │                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Pipeline      │  │   Message Ctr  │  │   Statistics    │  │
│  │                 │  │                 │  │                 │  │
│  │  • 流水线处理    │  │  • 消息中心      │  │  • 统计信息      │  │
│  │  • 事件记录      │  │  • 集成通信      │  │  • 性能监控      │  │
│  │  • 协调调度      │  │  • 全局实例      │  │  • 报告生成      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 模块依赖关系

```
┌─────────────────────────────────────────────────────────────────┐
│                       模块依赖关系                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐  │
│  │   RouteCodex    │    │  rcc-debugcenter │    │ rcc-errorhandling│  │
│  │                 │    │                 │    │                 │  │
│  │  • 主应用        │    │  • 调试中心      │    │  • 错误处理      │  │
│  │  • 服务器        │    │  • 主题订阅      │    │  • 异常管理      │  │
│  │  • 路由管理      │    │  • 会话跟踪      │    │  • 重试机制      │  │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘  │
│           │                       │                       │         │
│           └───────────────────────┼───────────────────────┘         │
│                                   │                               │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │                    rcc-basemodule                              │  │
│  │                                                                 │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │  │
│  │  │  MessageCenter  │  │   Interfaces    │  │   Utilities     │  │  │
│  │  │                 │  │                 │  │                 │  │
│  │  │  • 主题订阅      │  │  • 类型定义      │  │  • 工具函数      │  │
│  │  │  • 消息路由      │  │  • 接口规范      │  │  • 辅助方法      │  │
│  │  │  • 模块通信      │  │  • 数据结构      │  │  • 通用模块      │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  │  │
│  │                                                                 │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Conversion V3 流水线架构（llmswitch-core）

conversion v3 是 sharedmodule/llmswitch-core 提供的唯一转换与工具治理流水线，具备以下约束：

- **单一入口**：RouteCodex 仅通过 `src/modules/llmswitch/bridge.ts` → `sharedmodule/llmswitch-core/dist/v2/bridge/routecodex-adapter` 调用 conversion v3；禁止旁路 import core。
- **配置驱动节点链**：`config/pipeline-config.generated.json`（可被环境变量覆盖）中的 `llmSwitch.pipelineConfig` 定义每条入站/出站线路的节点序列：`SSE Input → Provider Input → Chat Process → Provider Output → SSE Output`，Responses/Anthropic 线路也遵循相同结构。自 V3 起，每条线路都会携带显式的 `processMode`（`chat` / `passthrough`）与 `mode`（是否 Passthrough）字段，`PipelineConfigManager` 会在匹配入口端点后优先筛选 provider protocol，再根据 `processMode` 命中对应流水线，彻底移除任何自动兜底。
- **Compatibility 回归 host 模块**：llmswitch-core 的流程节点只负责输入/处理/输出，不再加载 `compatibility-process`。所有 Provider 特定 patch（tool schema、GLM 字段裁剪等）都在 `src/modules/pipeline/modules/compatibility` 内按 providerId/providerType 命中，llmswitch 仅提供标准化请求与响应。
- **节点职责**
  - `nodes/sse/*`：SSE 入口/出口/直通节点，仅做 JSON ↔ SSE 序列化与元数据记录。
  - `nodes/input/*`：OpenAI Chat、OpenAI Responses、Anthropic Messages 入站解析器，校验 `model/messages` 并输出 canonical `standardizedRequest`。
  - `nodes/process/*`（当前为 `chat-process-node`）：唯一的工具治理点，处理 tool_calls 修复、上下文归一、MCP 规则、streaming 策略等。
  - `nodes/output/*`：按 Provider 协议生成响应（choices、usage、content blocks 等）。
  - `nodes/response/*`：出站入口节点，把 Provider 响应转换为 canonical，再交由 output/sse 节点返回。
- **工具治理原则**
  - 除 Compatibility 层为满足 OpenAI 协议做的最小字段修剪外，任何模块都不得修改工具语义。
  - 工具解析、修复、透传、执行判定必须发生在 `process` 链路；Input/Output/SSE/Response 节点只做格式转换或序列化。
  - 新增功能如需触碰工具，必须作为 `chat-process-node` 的子流程或新的 process 节点，并在 pipeline 配置中显式启用。

该架构确保三条链路（OpenAI/Anthropic/Responses、SSE/JSON）共享同一份逻辑，调试与快照都仅需关注 conversion v3 输出。

## 技术栈

### 核心技术

- **Node.js**: 运行时环境
- **TypeScript**: 类型安全的JavaScript
- **ESM**: 纯ES模块系统
- **Rollup**: 模块打包工具

### 构建工具

- **TypeScript**: 编译时类型检查
- **Rollup**: ESM模块打包
- **Jest**: 单元测试框架
- **ESLint**: 代码质量检查

### 发布工具

- **NPM**: 包管理器
- **Semantic Versioning**: 版本管理
- **CI/CD**: 自动化构建和发布

## 消息流程

### 主题订阅消息流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      主题订阅消息流程                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Publisher → MessageCenter → TopicSubscription → Subscribers   │
│      │             │                   │             │          │
│      │             │                   │             │          │
│  ┌─────┐      ┌──────┐          ┌──────┐      ┌──────┐         │
│  │Publish│      │Route │          │Topic │      │Receive│       │
│  │Message│      │Message│          │Match │      │Message│       │
│  └─────┘      └──────┘          └──────┘      └──────┘         │
│      │             │                   │             │          │
│      │             │                   │             │          │
│      ▼             ▼                   ▼             ▼          │
│  ┌─────┐      ┌──────┐          ┌──────┐      ┌──────┐         │
│  │Create│      │Validate│          │Filter│      │Process│       │
│  │Message│      │Message│          │Subs  │      │Message│       │
│  └─────┘      └──────┘          └──────┘      └──────┘         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 错误处理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        错误处理流程                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Error → ErrorHandling → Recovery → Retry/Fallback → Success     │
│    │         │              │          │            │          │
│    │         │              │          │            │          │
│  ┌───┐   ┌─────┐      ┌─────┐     ┌─────┐     ┌─────┐   ┌─────┐ │
│  │Cap│   │Class│      │Analyze│   │Retry│     │Fallback│ │Result│ │
│  │ture│   │ify │      │Error │   │Logic│     │Handler │ │Log  │ │
│  └───┘   └─────┘      └─────┘     └─────┘     └─────┘   └─────┘ │
│    │         │              │          │            │          │
│    │         │              │          │            │          │
│    ▼         ▼              ▼          ▼            ▼          │
│  ┌───┐   ┌─────┐      ┌─────┐     ┌─────┐     ┌─────┐   ┌─────┐ │
│  │Log │   │Track│      │Recover│   │Attempt│   │Alternative││End  │ │
│  │Error│   │Error│      │State  │   │Count │   │Solution│ │Flow │ │
│  └───┘   └─────┘      └─────┘     └─────┘     └─────┘   └─────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 配置管理

### 系统配置

```json
{
  "server": {
    "port": 5506,
    "host": "localhost",
    "cors": {
      "enabled": true,
      "origins": ["*"]
    }
  },
  "providers": {
    "openai-provider": {
      "type": "openai",
      "enabled": true,
      "baseUrl": "https://api.openai.com/v1",
      "apiKey": "your-api-key",
      "models": {
        "gpt-4": {
          "maxTokens": 8192,
          "temperature": 0.7
        }
      }
    }
  },
  "messageCenter": {
    "enableTopicSubscription": true,
    "topics": {
      "debug-events": "Debug events topic",
      "system-events": "System events topic"
    },
    "wildcardSubscription": true
  },
  "debugCenter": {
    "outputDirectory": "./debug-logs",
    "enableTopicSubscription": true,
    "topicSubscriptionConfig": {
      "debugTopic": "debug-events",
      "systemTopic": "system-events",
      "enableWildcardSubscription": true
    }
  }
}
```

### 主题订阅配置

```json
{
  "topicSubscription": {
    "enabled": true,
    "topics": {
      "debug-events": {
        "description": "Debug events topic",
        "subscribers": ["debugcenter", "monitoring"]
      },
      "system-events": {
        "description": "System events topic",
        "subscribers": ["debugcenter", "errorhandler"]
      },
      "user-events": {
        "description": "User events topic",
        "subscribers": ["analytics", "monitoring"]
      }
    },
    "wildcardEnabled": true,
    "wildcardSubscribers": ["debugcenter"]
  }
}
```

## 部署架构

### 开发环境

```
┌─────────────────────────────────────────────────────────────────┐
│                        开发环境                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Development   │  │   Testing       │  │   Debugging     │  │
│  │                 │  │                 │  │                 │  │
│  │  • 热重载        │  │  • 单元测试      │  │  • 调试工具      │  │
│  │  • 源码映射      │  │  • 集成测试      │  │  • 性能分析      │  │
│  │  • 开发日志      │  │  • 端到端测试    │  │  • 日志查看      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 生产环境

```
┌─────────────────────────────────────────────────────────────────┐
│                        生产环境                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Load Balancer │  │   RouteCodex    │  │   Monitoring    │  │
│  │                 │  │                 │  │                 │  │
│  │  • 负载均衡      │  │  • 多实例        │  │  • 性能监控      │  │
│  │  • 健康检查      │  │  • 容器化        │  │  • 日志收集      │  │
│  │  • 故障转移      │  │  • 自动扩展      │  │  • 告警通知      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│           │                       │                       │         │
│           └───────────────────────┼───────────────────────┘         │
│                                   │                               │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │                     Infrastructure                             │  │
│  │                                                                 │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │  │
│  │  │   Database      │  │   Cache         │  │   Queue         │  │  │
│  │  │                 │  │                 │  │                 │  │
│  │  │  • 数据存储      │  │  • 缓存管理      │  │  • 消息队列      │  │
│  │  │  • 会话存储      │  │  • 性能优化      │  │  • 异步处理      │  │
│  │  │  • 配置存储      │  │  • 数据同步      │  │  • 任务调度      │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  │  │
│  │                                                                 │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 版本信息

- **当前版本**: 0.0.1
- **最后更新**: 2025-01-22
- **维护团队**: RouteCodex 开发团队
- **文档版本**: 1.0.0

## 相关文档

- [README.md](./README.md) - 项目概述和快速开始
- [CONTRIBUTING.md](./CONTRIBUTING.md) - 贡献指南
- [CHANGELOG.md](./CHANGELOG.md) - 变更日志
- [API 文档](./docs/api/) - API 接口文档
- [部署指南](./docs/deployment/) - 部署相关文档
